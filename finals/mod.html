<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1N4L5 - Moderator Control</title>
    <style>
        :root {
            --purple: #8A2BE2;
            --cyan: #00FFFF;
            --yellow: #FFFF00;
            --pink: #FF69B4;
            --green: #00FF00;
            --red: #FF0000;
            --glass: rgba(0,0,0,0.7);
            --glass-light: rgba(255,255,255,0.1);
            --blur: 10px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            background-image: url('assets/finals-bg.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: -1;
        }

        .header {
            background: var(--glass);
            backdrop-filter: blur(var(--blur));
            padding: 20px;
            text-align: center;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 3px solid rgba(255,255,255,0.3);
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 20px var(--cyan), 3px 3px 0 #000;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .panel {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .panel:hover {
            border-color: var(--cyan);
            box-shadow: 0 10px 30px rgba(0,255,255,0.3);
        }

        .panel h2 {
            color: var(--cyan);
            margin-bottom: 20px;
            font-size: 1.8em;
            text-shadow: 0 0 10px var(--cyan);
        }

        .panel.priority {
            grid-column: 1 / -1;
            border-color: var(--yellow);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255,255,0,0.3); }
            50% { box-shadow: 0 0 40px rgba(255,255,0,0.6); }
        }

        /* Phase Control */
        .phase-control {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .phase-indicator {
            padding: 10px 20px;
            border-radius: 10px;
            background: var(--glass-light);
            border: 2px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }

        .phase-indicator.active {
            background: var(--cyan);
            color: #000;
            font-weight: bold;
            box-shadow: 0 0 20px var(--cyan);
        }

        /* Player Status Grid */
        .player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .player-card {
            background: var(--glass-light);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .player-card.selected {
            border-color: var(--yellow);
            background: rgba(255,255,0,0.1);
        }

        .player-card.safe {
            border-color: var(--green);
            background: rgba(0,255,0,0.1);
        }

        .player-card.danger {
            border-color: var(--red);
            background: rgba(255,0,0,0.1);
        }

        .player-card.eliminated {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: bold;
            font-size: 0.9em;
        }

        .player-status {
            font-size: 0.8em;
            color: #999;
        }

        .player-phone {
            font-size: 0.8em;
            color: var(--yellow);
        }

        /* Death Ratio Control */
        .ratio-control {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255,0,0,0.1);
            border: 2px solid var(--red);
            border-radius: 10px;
        }

        .ratio-input {
            width: 80px;
            padding: 8px;
            font-size: 1.2em;
            background: rgba(0,0,0,0.5);
            border: 2px solid var(--red);
            color: white;
            border-radius: 5px;
            text-align: center;
        }

        /* Buttons */
        button {
            background: var(--cyan);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 5px;
        }

        button:hover {
            background: var(--yellow);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(255,255,0,0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.danger {
            background: #ff3333;
            color: white;
        }

        button.danger:hover {
            background: #ff5555;
            box-shadow: 0 8px 25px rgba(255,51,51,0.4);
        }

        button.success {
            background: #00ff00;
            color: #000;
        }

        button.success:hover {
            background: #33ff33;
            box-shadow: 0 8px 25px rgba(0,255,0,0.4);
        }

        button.primary {
            background: var(--purple);
            color: white;
        }

        button.primary:hover {
            background: var(--pink);
            box-shadow: 0 8px 25px rgba(255,105,180,0.4);
        }

        /* Phone Assignment Display */
        .phone-assignments {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .phone-assignment {
            background: var(--glass-light);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            font-size: 0.9em;
        }

        .phone-assignment.spice {
            border-color: var(--green);
            background: rgba(0,255,0,0.1);
        }

        .phone-assignment.ed {
            border-color: var(--red);
            background: rgba(255,0,0,0.1);
        }

        /* Challenge Editor */
        .challenge-editor {
            margin-top: 20px;
        }

        .challenge-item {
            background: var(--glass-light);
            border: 2px solid rgba(138,43,226,0.5);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .challenge-item textarea {
            width: 100%;
            min-height: 80px;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px;
            border-radius: 5px;
            resize: vertical;
        }

        .challenge-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* Battle Matchups Display */
        .battle-matchup-panel {
            background: rgba(255,0,0,0.1);
            border: 3px solid var(--red);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .matchup-container {
            display: grid;
            gap: 20px;
        }

        .single-matchup {
            background: var(--glass-light);
            border: 2px solid var(--purple);
            border-radius: 10px;
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
        }

        .matchup-team {
            text-align: center;
        }

        .matchup-team h4 {
            color: var(--cyan);
            margin-bottom: 10px;
        }

        .matchup-fighter {
            color: var(--red);
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .matchup-helpers {
            font-size: 0.9em;
            color: #ccc;
        }

        .matchup-vs {
            color: var(--red);
            font-size: 2em;
            font-weight: bold;
        }

        .winner-selector {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .winner-button {
            padding: 10px 20px;
            background: var(--glass-light);
            border: 2px solid var(--yellow);
            color: var(--yellow);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .winner-button:hover {
            background: var(--yellow);
            color: #000;
        }

        .winner-button.selected {
            background: var(--green);
            color: #000;
            border-color: var(--green);
        }

        /* Stats Display */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: var(--glass-light);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            color: var(--yellow);
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9em;
            color: #999;
            margin-top: 5px;
        }

        /* Log */
        .log-container {
            background: rgba(0,0,0,0.8);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }

        .log-entry {
            margin: 3px 0;
            padding: 3px;
        }

        .log-entry.success { color: #00ff00; }
        .log-entry.error { color: #ff3333; }
        .log-entry.warning { color: var(--yellow); }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .panel.priority {
                grid-column: 1;
            }
            
            .single-matchup {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .matchup-vs {
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎮 F1N4L5 MODERATOR CONTROL 🎮</h1>
    </div>

    <div class="main-grid">
        <!-- GAME CONTROL -->
        <div class="panel priority">
            <h2>🎯 Game Control</h2>
            <div class="phase-control">
                <div class="phase-indicator" id="phase-waiting">⏳ Waiting</div>
                <div class="phase-indicator" id="phase-selecting">📱 Selecting</div>
                <div class="phase-indicator" id="phase-revealing">🎭 Revealing</div>
                <div class="phase-indicator" id="phase-fighting">⚔️ Fighting</div>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="startPhoneSelection()" id="startSelectionBtn" class="success">
                    Start Phone Selection
                </button>
                <button onclick="stopPhoneSelection()" id="stopSelectionBtn" disabled class="danger">
                    Stop Selection
                </button>
                <button onclick="revealResults()" id="revealBtn" disabled class="primary">
                    Reveal Results
                </button>
                <button onclick="startFightPhase()" id="fightBtn" disabled class="danger">
                    Start Fight Phase
                </button>
                <button onclick="nextRound()" id="nextRoundBtn" disabled>
                    Next Round
                </button>
            </div>
            
            <div class="ratio-control">
                <label>💀 Players to Eliminate:</label>
                <input type="number" id="deathCount" class="ratio-input" min="1" max="19" value="4">
                <span id="deathRatioText">players</span>
                <button onclick="updateDeathRatio()" class="danger">Update Count</button>
            </div>
        </div>

        <!-- PLAYER STATUS -->
        <div class="panel">
            <h2>👥 Player Status</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalPlayers">0</div>
                    <div class="stat-label">Total Players</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activePlayers">0</div>
                    <div class="stat-label">Active</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="eliminatedPlayers">0</div>
                    <div class="stat-label">Eliminated</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="currentRound">1</div>
                    <div class="stat-label">Round</div>
                </div>
            </div>
            
            <h3 style="margin-top: 20px; color: var(--yellow);">Active Players</h3>
            <div class="player-grid" id="playerGrid"></div>
            
            <h3 style="margin-top: 20px; color: var(--red);">Eliminated Players</h3>
            <div class="player-grid" id="eliminatedGrid"></div>
        </div>

        <!-- PHONE ASSIGNMENTS -->
        <div class="panel">
            <h2>📱 Phone Assignments</h2>
            <div id="phoneAssignments" class="phone-assignments">
                <p style="color: #666; text-align: center;">No phones assigned yet</p>
            </div>
        </div>

        <!-- SELECTION TRACKING -->
        <div class="panel">
            <h2>🎯 Current Selections</h2>
            <div id="selectionTracking">
                <p style="color: #666; text-align: center;">Waiting for selections...</p>
            </div>
        </div>

        <!-- FIGHT PHASE -->
        <div class="panel" id="fightPanel" style="display: none;">
            <h2>⚔️ Fight Phase Control</h2>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: var(--yellow);">Select Challenge:</h3>
                <select id="challengeSelect" style="width: 100%; padding: 10px; margin-bottom: 10px; background: rgba(0,0,0,0.5); color: white; border: 2px solid var(--yellow);">
                    <option value="">Select a challenge...</option>
                </select>
                <button onclick="activateChallenge()" class="primary" style="width: 100%;">REVEAL CHALLENGE TO PLAYERS</button>
            </div>
            
            <div class="battle-matchup-panel">
                <h3 style="color: var(--red); text-align: center; margin-bottom: 20px;">BATTLE MATCHUPS</h3>
                <div id="matchupContainer" class="matchup-container"></div>
                <button onclick="declareWinners()" class="success" style="margin-top: 20px; width: 100%;">Confirm Winners & Eliminate Losers</button>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="regenerateMatchups()" class="primary">Regenerate Matchups</button>
                <button onclick="cancelFightPhase()" class="danger">Cancel Fight Phase</button>
            </div>
        </div>

        <!-- CHALLENGE EDITOR -->
        <div class="panel">
            <h2>📝 Challenge Editor</h2>
            <div class="challenge-editor">
                <button onclick="addChallenge()" class="success">+ Add New Challenge</button>
                <div id="challengeList" style="margin-top: 15px;"></div>
            </div>
        </div>

        <!-- QUICK ACTIONS -->
        <div class="panel">
            <h2>⚡ Quick Actions</h2>
            <button onclick="addCustomPlayer()" class="success">+ Add Custom Player</button>
            <button onclick="resetRound()" class="danger">Reset Current Round</button>
            <button onclick="resetGame()" class="danger">Reset F1N4L5 Game</button>
            <button onclick="markPlayerEliminated()" class="danger">Manually Eliminate Player</button>
            <button onclick="revivePlayer()" class="success">Revive Player</button>
            <button onclick="viewRawData()">View Raw Data</button>
        </div>

        <!-- LOG -->
        <div class="panel">
            <h2>📜 Activity Log</h2>
            <div class="log-container" id="gameLog"></div>
            <button onclick="clearLog()" style="margin-top: 10px;">Clear Log</button>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDnHE2Ay2wqZVC4Xf2PsHHppVoVfNPk0hI",
            authDomain: "f0und3rzg4m3-b04rd.firebaseapp.com",
            databaseURL: "https://f0und3rzg4m3-b04rd-default-rtdb.firebaseio.com",
            projectId: "f0und3rzg4m3-b04rd",
            storageBucket: "f0und3rzg4m3-b04rd.firebasestorage.app",
            messagingSenderId: "484982613831",
            appId: "1:484982613831:web:9b655b3d66d66b3b5e8e62",
            measurementId: "G-MPN2LP1Q6X"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Eligible founders
        let eligibleFounders = [
            { id: '45_sean_rad', name: 'Sean Rad', team: 1, image: '45_sean_rad.png' },
            { id: '35_tom_anderson', name: 'Tom Anderson', team: 1, image: '35_tom_anderson.png' },
            { id: '17_sam_altman', name: 'Sam Altman', team: 1, image: '17_sam_altman.png' },
            { id: '11_google_founders', name: 'Larry Page & Sergey Brin', team: 1, image: '11_google_founders.png' },
            { id: '28_adam_neumann', name: 'Adam Neumann', team: 2, image: '28_adam_neumann.png' },
            { id: '51_zhang_yiming', name: 'Zhang Yiming', team: 2, image: '51_zhang_yiming.png' },
            { id: '48_sam_bankman_fried', name: 'Sam Bankman-Fried', team: 2, image: '48_sam_bankman-fried.png' },
            { id: '24_larry_ellison', name: 'Larry Ellison', team: 2, image: '24_larry_ellison.png' },
            { id: '21_jimmy_wales', name: 'Jimmy Wales', team: 2, image: '21_jimmy_wales.png' },
            { id: '46_dread_pirate', name: 'Ross Ulbricht', team: 2, image: '46_dread_pirate.png' },
            { id: '27_travis_kalanick', name: 'Travis Kalanick', team: 2, image: '27_travis_kalanick.png' },
            { id: '37_steve_wozniak', name: 'Steve Wozniak', team: 2, image: '37_steve_wozniak.png' },
            { id: '53_youtube', name: 'YouTube Founders', team: 2, image: '53_youtube.png' },
            { id: '36_alexis_ohanian', name: 'Alexis Ohanian', team: 2, image: '36_alexis_ohanian.png' },
            { id: '43_sophia_amoruso', name: 'Sophia Amoruso', team: 2, image: '43_sophia_amoruso.png' },
            { id: '33_martin_shkreli', name: 'Martin Shkreli', team: 2, image: '33_martin_shkreli.png' },
            // Test players (no images)
            { id: 'test_player_1', name: 'Test Player 1', team: 1, image: null },
            { id: 'test_player_2', name: 'Test Player 2', team: 2, image: null }
        ];

        // Game state
        let gameState = {
            phase: 'waiting',
            round: 1,
            activePlayers: {},
            eliminatedPlayers: [],
            phoneAssignments: {},
            playerSelections: {},
            deathRatio: 4,
            challenges: [],
            fightingPlayers: [],
            founderWealth: {},
            battleMatchups: {},
            matchupWinners: {}
        };

        // Logging
        function log(message, type = 'normal') {
            const logDiv = document.getElementById('gameLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('gameLog').innerHTML = '';
            log('Log cleared', 'success');
        }

        // Update phase display
        function updatePhaseDisplay(phase) {
            document.querySelectorAll('.phase-indicator').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById(`phase-${phase}`).classList.add('active');
            
            // Update button states
            switch(phase) {
                case 'waiting':
                    document.getElementById('startSelectionBtn').disabled = false;
                    document.getElementById('stopSelectionBtn').disabled = true;
                    document.getElementById('revealBtn').disabled = true;
                    document.getElementById('fightBtn').disabled = true;
                    document.getElementById('nextRoundBtn').disabled = true;
                    document.getElementById('fightPanel').style.display = 'none';
                    break;
                case 'selecting':
                    document.getElementById('startSelectionBtn').disabled = true;
                    document.getElementById('stopSelectionBtn').disabled = false;
                    document.getElementById('revealBtn').disabled = false;
                    document.getElementById('fightBtn').disabled = true;
                    document.getElementById('nextRoundBtn').disabled = true;
                    break;
                case 'revealing':
                    document.getElementById('startSelectionBtn').disabled = true;
                    document.getElementById('stopSelectionBtn').disabled = true;
                    document.getElementById('revealBtn').disabled = true;
                    document.getElementById('fightBtn').disabled = false;
                    document.getElementById('nextRoundBtn').disabled = false;
                    break;
                case 'fighting':
                    document.getElementById('startSelectionBtn').disabled = true;
                    document.getElementById('stopSelectionBtn').disabled = true;
                    document.getElementById('revealBtn').disabled = true;
                    document.getElementById('fightBtn').disabled = true;
                    document.getElementById('nextRoundBtn').disabled = false;
                    document.getElementById('fightPanel').style.display = 'block';
                    break;
            }
        }

        // Start phone selection
        function startPhoneSelection() {
            // Clear previous round data
            database.ref('finals/currentRound').remove();
            
            // Update phase
            database.ref('finals/gameState/phase').set('selecting');
            
            log('Started phone selection phase', 'success');
        }

        // Stop phone selection
        function stopPhoneSelection() {
            database.ref('finals/gameState/phase').set('waiting');
            log('Stopped phone selection phase', 'warning');
        }

        // Reveal results with death assignments
      // Fixed revealResults function for the moderator board
function revealResults() {
    const selections = gameState.playerSelections;
    const deathCount = parseInt(document.getElementById('deathCount').value);
    
    // Get all players who selected phones
    const playerIds = Object.keys(selections);
    
    if (playerIds.length === 0) {
        alert('No players have selected phones yet!');
        return;
    }
    
    // Randomly select players to eliminate
    const shuffled = [...playerIds];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    
    const toEliminate = shuffled.slice(0, Math.min(deathCount, shuffled.length));
    
    console.log('Players to eliminate:', toEliminate);
    console.log('Player selections:', selections);
    
    // Create results and phone assignments based on actual player selections
    const results = {};
    const phoneAssignments = {};
    
    // Assign sounds directly to the phones that players selected
    Object.entries(selections).forEach(([playerId, data]) => {
        const phoneId = data.phoneId;
        const isEliminated = toEliminate.includes(playerId);
        
        if (isEliminated) {
            // Ed Sheeran (death) - files 12-20
            const soundIndex = 12 + Math.floor(Math.random() * 9); // Random between 12-20
            const soundFile = `finals-${soundIndex}`;
            
            phoneAssignments[phoneId] = {
                sound: soundFile,
                type: 'ed'
            };
            
            results[playerId] = {
                phoneId: phoneId,
                sound: soundFile,
                type: 'ed'
            };
        } else {
            // Spice Girls (safe) - files 1-11
            const soundIndex = 1 + Math.floor(Math.random() * 11); // Random between 1-11
            const soundFile = `finals-${soundIndex}`;
            
            phoneAssignments[phoneId] = {
                sound: soundFile,
                type: 'spice'
            };
            
            results[playerId] = {
                phoneId: phoneId,
                sound: soundFile,
                type: 'spice'
            };
        }
    });
    
    console.log('Generated results:', results);
    console.log('Phone assignments:', phoneAssignments);
    
    // Save assignments and results
    database.ref('finals/currentRound/phoneAssignments').set(phoneAssignments);
    database.ref('finals/currentRound/deathCount').set(deathCount);
    database.ref('finals/currentRound/revealResults').set(results);
    database.ref('finals/gameState/phase').set('revealing');
    
    log(`Revealed results: ${toEliminate.length} players selected for elimination`, toEliminate.length > 0 ? 'error' : 'success');
} 

        // Start fight phase
        function startFightPhase() {
            // Get fighting players (those who got Ed Sheeran and didn't opt out)
            const results = gameState.revealResults || {};
            const optedOut = gameState.optedOut || {};
            const fighting = [];
            
            Object.entries(results).forEach(([playerId, result]) => {
                if (result.type === 'ed' && !optedOut[playerId]) {
                    fighting.push(playerId);
                }
            });
            
            if (fighting.length === 0) {
                alert('No players are fighting (all opted out)!');
                return;
            }
            
            // Store fighting players
            database.ref('finals/currentRound/fightingPlayers').set(fighting);
            
            // Generate matchups
            generateBattleMatchups(fighting);
            
            // Update phase
            database.ref('finals/gameState/phase').set('fighting');
            
            log(`Fight phase started with ${fighting.length} players`, 'warning');
        }

        // Generate battle matchups
        function generateBattleMatchups(fightingPlayers) {
            const matchups = {};
            
            // Get all available helpers (active + eliminated)
            const allPlayers = [
                ...Object.keys(gameState.activePlayers),
                ...gameState.eliminatedPlayers
            ];
            
            // Remove fighting players from helper pool
            const helpers = allPlayers.filter(p => !fightingPlayers.includes(p));
            
            // Shuffle helpers
            const shuffledHelpers = [...helpers];
            for (let i = shuffledHelpers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledHelpers[i], shuffledHelpers[j]] = [shuffledHelpers[j], shuffledHelpers[i]];
            }
            
            // Pair up fighters for battles
            const shuffledFighters = [...fightingPlayers];
            for (let i = shuffledFighters.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledFighters[i], shuffledFighters[j]] = [shuffledFighters[j], shuffledFighters[i]];
            }
            
            // Create matchups
            let helperIndex = 0;
            const helpersPerTeam = Math.floor(shuffledHelpers.length / shuffledFighters.length);
            
            for (let i = 0; i < shuffledFighters.length; i += 2) {
                const matchId = `match_${Math.floor(i / 2) + 1}`;
                
                // If odd number of fighters, last one fights alone
                if (i === shuffledFighters.length - 1) {
                    matchups[matchId] = {
                        teamA: [shuffledFighters[i], ...shuffledHelpers.slice(helperIndex, helperIndex + helpersPerTeam * 2)],
                        teamB: [] // Solo fighter gets all helpers
                    };
                } else {
                    // Team A
                    const teamA = [shuffledFighters[i]];
                    for (let j = 0; j < helpersPerTeam && helperIndex < shuffledHelpers.length; j++) {
                        teamA.push(shuffledHelpers[helperIndex++]);
                    }
                    
                    // Team B
                    const teamB = [shuffledFighters[i + 1]];
                    for (let j = 0; j < helpersPerTeam && helperIndex < shuffledHelpers.length; j++) {
                        teamB.push(shuffledHelpers[helperIndex++]);
                    }
                    
                    matchups[matchId] = { teamA, teamB };
                }
            }
            
            database.ref('finals/currentRound/battleMatchups').set(matchups);
            gameState.matchupWinners = {};
            log(`Generated ${Object.keys(matchups).length} battle matchups`, 'success');
        }

        // Regenerate matchups
        function regenerateMatchups() {
            const fighting = gameState.fightingPlayers || [];
            if (fighting.length > 0) {
                generateBattleMatchups(fighting);
                updateMatchupDisplay();
            }
        }

        // Activate challenge
        function activateChallenge() {
            const challengeId = document.getElementById('challengeSelect').value;
            if (!challengeId) {
                alert('Please select a challenge!');
                return;
            }
            
            const challenge = gameState.challenges.find(c => c.id === challengeId);
            if (challenge) {
                database.ref('finals/currentRound/activeChallenge').set(challenge);
                log(`Activated challenge: ${challenge.description}`, 'success');
            }
        }

        // Cancel fight phase
        function cancelFightPhase() {
            if (confirm('Cancel fight phase? This will return to waiting phase.')) {
                database.ref('finals/gameState/phase').set('waiting');
                database.ref('finals/currentRound/battleMatchups').remove();
                database.ref('finals/currentRound/activeChallenge').remove();
                database.ref('finals/currentRound/fightingPlayers').remove();
                
                log(`Fight phase cancelled`, 'warning');
            }
        }

        // Declare winners
        function declareWinners() {
            const losers = [];
            
            Object.entries(gameState.battleMatchups).forEach(([matchId, teams]) => {
                const winner = gameState.matchupWinners[matchId];
                if (!winner) {
                    alert(`Please select a winner for all matchups!`);
                    return;
                }
                
                // Find the losing fighter
                if (winner === 'A' && teams.teamB[0]) {
                    losers.push(teams.teamB[0]);
                } else if (winner === 'B' && teams.teamA[0]) {
                    losers.push(teams.teamA[0]);
                }
            });
            
            if (losers.length === 0) {
                alert('No losers to eliminate!');
                return;
            }
            
            if (confirm(`Eliminate ${losers.length} losing players?`)) {
                // Get current eliminated list
                const currentEliminated = gameState.eliminatedPlayers || [];
                const newEliminated = [...currentEliminated, ...losers];
                
                // Update eliminated list
                database.ref('finals/gameState/eliminatedPlayers').set(newEliminated);
                
                // Remove from active players
                losers.forEach(playerId => {
                    database.ref(`finals/activePlayers/${playerId}`).remove();
                });
                
                // Clear fight phase data
                database.ref('finals/currentRound').remove().then(() => {
                    database.ref('finals/gameState/phase').set('waiting');
                });
                
                log(`Fight phase ended, ${losers.length} players eliminated`, 'success');
            }
        }

        // Next round
        function nextRound() {
            if (confirm('Start next round? This will clear all current selections.')) {
                const newRound = gameState.round + 1;
                
                // Clear current round data
                database.ref('finals/currentRound').remove().then(() => {
                    // Update round number and phase
                    database.ref('finals/gameState/round').set(newRound);
                    database.ref('finals/gameState/phase').set('waiting');
                    
                    log(`Advanced to round ${newRound}`, 'success');
                });
            }
        }

        // Update death ratio
        function updateDeathRatio() {
            const count = parseInt(document.getElementById('deathCount').value);
            const totalPlayers = Object.keys(gameState.activePlayers).length;
            
            if (count >= totalPlayers) {
                alert(`Cannot eliminate ${count} players when only ${totalPlayers} are active!`);
                return;
            }
            
            database.ref('finals/currentRound/deathCount').set(count);
            log(`Updated elimination count to ${count} players`, 'warning');
        }

        // Challenge management
        let challengeIdCounter = 0;

        function addChallenge() {
            const id = `challenge_${Date.now()}_${challengeIdCounter++}`;
            const challenge = {
                id: id,
                description: '',
                active: true
            };
            
            gameState.challenges.push(challenge);
            database.ref(`finals/challenges/${id}`).set(challenge);
            updateChallengeDisplay();
        }

        function updateChallengeDisplay() {
            const list = document.getElementById('challengeList');
            const select = document.getElementById('challengeSelect');
            
            list.innerHTML = '';
            select.innerHTML = '<option value="">Select a challenge...</option>';
            
            gameState.challenges.forEach(challenge => {
                // List item
                const item = document.createElement('div');
                item.className = 'challenge-item';
                item.innerHTML = `
                    <textarea placeholder="Enter challenge description..." 
                              onchange="updateChallenge('${challenge.id}', this.value)"
                              onblur="updateChallenge('${challenge.id}', this.value)">${challenge.description}</textarea>
                    <div class="challenge-controls">
                        <span style="color: var(--cyan); font-size: 0.9em;">${challenge.description ? 'Saved ✓' : 'Not saved'}</span>
                        <button onclick="deleteChallenge('${challenge.id}')" class="danger">Delete</button>
                    </div>
                `;
                list.appendChild(item);
                
                // Select option
                if (challenge.description) {
                    const option = document.createElement('option');
                    option.value = challenge.id;
                    option.textContent = challenge.description.substring(0, 50) + (challenge.description.length > 50 ? '...' : '');
                    select.appendChild(option);
                }
            });
        }

        function updateChallenge(id, description) {
            database.ref(`finals/challenges/${id}/description`).set(description);
            const challenge = gameState.challenges.find(c => c.id === id);
            if (challenge) {
                challenge.description = description;
            }
            updateChallengeDisplay();
        }

        function deleteChallenge(id) {
            database.ref(`finals/challenges/${id}`).remove();
            gameState.challenges = gameState.challenges.filter(c => c.id !== id);
            updateChallengeDisplay();
        }

        // Player management
        function updatePlayerDisplay() {
            const activeGrid = document.getElementById('playerGrid');
            const eliminatedGrid = document.getElementById('eliminatedGrid');
            
            activeGrid.innerHTML = '';
            eliminatedGrid.innerHTML = '';
            
            // Active players
            Object.entries(gameState.activePlayers).forEach(([playerId, data]) => {
                const founder = eligibleFounders.find(f => f.id === playerId);
                if (!founder) return;
                
                const card = createPlayerCard(founder, data);
                activeGrid.appendChild(card);
            });
            
            // Eliminated players
            gameState.eliminatedPlayers.forEach(playerId => {
                const founder = eligibleFounders.find(f => f.id === playerId);
                if (!founder) return;
                
                const card = createPlayerCard(founder, null, true);
                eliminatedGrid.appendChild(card);
            });
            
            // Update stats
            const totalActive = Object.keys(gameState.activePlayers).length;
            const totalEliminated = gameState.eliminatedPlayers.length;
            
            document.getElementById('totalPlayers').textContent = totalActive + totalEliminated;
            document.getElementById('activePlayers').textContent = totalActive;
            document.getElementById('eliminatedPlayers').textContent = totalEliminated;
        }

        function createPlayerCard(founder, data, eliminated = false) {
            const card = document.createElement('div');
            card.className = 'player-card';
            
            if (eliminated) {
                card.classList.add('eliminated');
            } else if (gameState.playerSelections[founder.id]) {
                card.classList.add('selected');
            }
            
            // Check if player has result
            if (gameState.revealResults && gameState.revealResults[founder.id]) {
                const result = gameState.revealResults[founder.id];
                card.classList.add(result.type === 'spice' ? 'safe' : 'danger');
            }
            
            const wealth = gameState.founderWealth[founder.id] || 0;
            const selection = gameState.playerSelections[founder.id];
            
            // Check if test player or custom player without image
            if (!founder.image || founder.id.includes('test_player')) {
                card.innerHTML = `
                    <div style="width: 40px; height: 40px; display: inline-block;"></div>
                    <div class="player-info">
                        <div class="player-name">${founder.name}</div>
                        <div class="player-status">${wealth.toLocaleString()}</div>
                        ${selection ? `<div class="player-phone">${selection.phoneId}</div>` : ''}
                    </div>
                `;
            } else {
                card.innerHTML = `
                    <img src="../jeopardy/assets/founders/${founder.image}" class="player-avatar" 
                         onerror="this.src='../jeopardy/assets/founders/default.png'">
                    <div class="player-info">
                        <div class="player-name">${founder.name}</div>
                        <div class="player-status">${wealth.toLocaleString()}</div>
                        ${selection ? `<div class="player-phone">${selection.phoneId}</div>` : ''}
                    </div>
                `;
            }
            
            return card;
        }

        // Phone assignment display
        function updatePhoneAssignments() {
            const container = document.getElementById('phoneAssignments');
            container.innerHTML = '';
            
            if (Object.keys(gameState.phoneAssignments).length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">No phones assigned yet</p>';
                return;
            }
            
            Object.entries(gameState.phoneAssignments).forEach(([phoneId, assignment]) => {
                const div = document.createElement('div');
                div.className = `phone-assignment ${assignment.type}`;
                div.innerHTML = `
                    <div style="font-weight: bold;">${phoneId}</div>
                    <div style="font-size: 0.8em;">${assignment.sound}</div>
                    <div style="font-size: 0.8em; text-transform: uppercase;">${assignment.type}</div>
                `;
                container.appendChild(div);
            });
        }

        // Selection tracking display
        function updateSelectionTracking() {
            const container = document.getElementById('selectionTracking');
            
            if (Object.keys(gameState.playerSelections).length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">Waiting for selections...</p>';
                return;
            }
            
            container.innerHTML = '';
            Object.entries(gameState.playerSelections).forEach(([playerId, data]) => {
                const founder = eligibleFounders.find(f => f.id === playerId);
                if (!founder) return;
                
                const assignment = gameState.phoneAssignments[data.phoneId];
                
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; justify-content: space-between; padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.05); border-radius: 8px;';
                div.innerHTML = `
                    <span>${founder.name}</span>
                    <span>${data.phoneId}</span>
                    ${assignment ? `<span style="color: ${assignment.type === 'spice' ? 'var(--green)' : 'var(--red)'}">${assignment.type.toUpperCase()}</span>` : ''}
                `;
                container.appendChild(div);
            });
        }

        // Matchup display
        function updateMatchupDisplay() {
            const container = document.getElementById('matchupContainer');
            container.innerHTML = '';
            
            Object.entries(gameState.battleMatchups).forEach(([matchId, teams]) => {
                const matchDiv = document.createElement('div');
                matchDiv.className = 'single-matchup';
                
                // Team A
                const teamADiv = document.createElement('div');
                teamADiv.className = 'matchup-team';
                teamADiv.innerHTML = '<h4>TEAM A</h4>';
                
                const fighterA = eligibleFounders.find(f => f.id === teams.teamA[0]);
                if (fighterA) {
                    const fighterDiv = document.createElement('div');
                    fighterDiv.className = 'matchup-fighter';
                    fighterDiv.textContent = `💀 ${fighterA.name}`;
                    teamADiv.appendChild(fighterDiv);
                }
                
                if (teams.teamA.length > 1) {
                    const helpersDiv = document.createElement('div');
                    helpersDiv.className = 'matchup-helpers';
                    helpersDiv.innerHTML = '<strong>Helpers:</strong><br>';
                    teams.teamA.slice(1).forEach(helperId => {
                        const helper = eligibleFounders.find(f => f.id === helperId);
                        if (helper) {
                            helpersDiv.innerHTML += `${helper.name}<br>`;
                        }
                    });
                    teamADiv.appendChild(helpersDiv);
                }
                
                matchDiv.appendChild(teamADiv);
                
                // VS
                const vsDiv = document.createElement('div');
                vsDiv.className = 'matchup-vs';
                vsDiv.textContent = 'VS';
                matchDiv.appendChild(vsDiv);
                
                // Team B
                const teamBDiv = document.createElement('div');
                teamBDiv.className = 'matchup-team';
                
                if (teams.teamB.length > 0) {
                    teamBDiv.innerHTML = '<h4>TEAM B</h4>';
                    
                    const fighterB = eligibleFounders.find(f => f.id === teams.teamB[0]);
                    if (fighterB) {
                        const fighterDiv = document.createElement('div');
                        fighterDiv.className = 'matchup-fighter';
                        fighterDiv.textContent = `💀 ${fighterB.name}`;
                        teamBDiv.appendChild(fighterDiv);
                    }
                    
                    if (teams.teamB.length > 1) {
                        const helpersDiv = document.createElement('div');
                        helpersDiv.className = 'matchup-helpers';
                        helpersDiv.innerHTML = '<strong>Helpers:</strong><br>';
                        teams.teamB.slice(1).forEach(helperId => {
                            const helper = eligibleFounders.find(f => f.id === helperId);
                            if (helper) {
                                helpersDiv.innerHTML += `${helper.name}<br>`;
                            }
                        });
                        teamBDiv.appendChild(helpersDiv);
                    }
                } else {
                    teamBDiv.innerHTML = '<h4>SOLO FIGHT</h4><div style="color: #666;">Fighting alone!</div>';
                }
                
                matchDiv.appendChild(teamBDiv);
                
                // Winner selector
                const winnerDiv = document.createElement('div');
                winnerDiv.className = 'winner-selector';
                winnerDiv.style.gridColumn = '1 / -1';
                
                const btnA = document.createElement('button');
                btnA.className = 'winner-button';
                btnA.textContent = 'Team A Wins';
                btnA.onclick = () => selectWinner(matchId, 'A', btnA, btnB);
                if (gameState.matchupWinners[matchId] === 'A') btnA.classList.add('selected');
                
                const btnB = document.createElement('button');
                btnB.className = 'winner-button';
                btnB.textContent = teams.teamB.length > 0 ? 'Team B Wins' : 'Solo Fighter Wins';
                btnB.onclick = () => selectWinner(matchId, 'B', btnB, btnA);
                if (gameState.matchupWinners[matchId] === 'B') btnB.classList.add('selected');
                
                winnerDiv.appendChild(btnA);
                if (teams.teamB.length > 0) {
                    winnerDiv.appendChild(btnB);
                }
                
                matchDiv.appendChild(winnerDiv);
                container.appendChild(matchDiv);
            });
        }

        function selectWinner(matchId, team, selectedBtn, otherBtn) {
            gameState.matchupWinners[matchId] = team;
            selectedBtn.classList.add('selected');
            if (otherBtn) otherBtn.classList.remove('selected');
            log(`Selected Team ${team} as winner for ${matchId}`, 'success');
        }

        // Quick actions
        function addCustomPlayer() {
            const name = prompt('Enter player name:');
            if (!name) return;
            
            const team = prompt('Enter team number (1 or 2):');
            if (team !== '1' && team !== '2') {
                alert('Team must be 1 or 2');
                return;
            }
            
            const id = `custom_${Date.now()}`;
            const newPlayer = {
                id: id,
                name: name,
                team: parseInt(team),
                image: null
            };
            
            // Add to local array
            eligibleFounders.push(newPlayer);
            
            // Add to Firebase
            database.ref(`finals/customPlayers/${id}`).set(newPlayer);
            database.ref(`finals/activePlayers/${id}`).set({
                name: name,
                team: parseInt(team),
                joinedAt: Date.now()
            });
            
            // Set default wealth
            database.ref(`game/founderWealth/${id}`).set(10000);
            
            log(`Added custom player: ${name} to Team ${team}`, 'success');
            updatePlayerDisplay();
        }

        function resetRound() {
            if (confirm('Reset current round? This will clear all selections.')) {
                database.ref('finals/currentRound').remove();
                database.ref('finals/gameState/phase').set('waiting');
                log('Reset current round', 'warning');
            }
        }

        function resetGame() {
            if (confirm('Reset F1N4L5 game data? This will clear all Finals data but preserve main game data.')) {
                if (confirm('FINAL CONFIRMATION: Reset the Finals round?')) {
                    // Clear all finals data
                    database.ref('finals').remove().then(() => {
                        // Re-initialize with default state
                        database.ref('finals/gameState').set({
                            phase: 'waiting',
                            round: 1,
                            eliminatedPlayers: []
                        });
                        
                        // Re-add eligible players as active (excluding test players initially)
                        eligibleFounders.forEach(founder => {
                            if (!founder.id.includes('test_player')) {
                                database.ref(`finals/activePlayers/${founder.id}`).set({
                                    name: founder.name,
                                    team: founder.team,
                                    joinedAt: Date.now()
                                });
                            }
                        });
                        
                        log('F1N4L5 RESET - All players restored', 'error');
                        setTimeout(() => location.reload(), 1000);
                    });
                }
            }
        }

        function markPlayerEliminated() {
            const playerId = prompt('Enter player ID to eliminate:');
            if (playerId && gameState.activePlayers[playerId]) {
                const eliminated = [...gameState.eliminatedPlayers, playerId];
                database.ref('finals/gameState/eliminatedPlayers').set(eliminated);
                database.ref(`finals/activePlayers/${playerId}`).remove();
                log(`Manually eliminated ${playerId}`, 'error');
            }
        }

        function revivePlayer() {
            const playerId = prompt('Enter player ID to revive:');
            if (playerId && gameState.eliminatedPlayers.includes(playerId)) {
                const eliminated = gameState.eliminatedPlayers.filter(p => p !== playerId);
                database.ref('finals/gameState/eliminatedPlayers').set(eliminated);
                
                const founder = eligibleFounders.find(f => f.id === playerId);
                if (founder) {
                    database.ref(`finals/activePlayers/${playerId}`).set({
                        name: founder.name,
                        team: founder.team,
                        revivedAt: Date.now()
                    });
                }
                
                log(`Revived ${playerId}`, 'success');
            }
        }

        function viewRawData() {
            console.log('Current Game State:', gameState);
            alert('Game state logged to console (F12)');
        }

        // Setup listeners
        function setupListeners() {
            // Game state
            database.ref('finals/gameState').on('value', (snapshot) => {
                const state = snapshot.val() || {};
                gameState.phase = state.phase || 'waiting';
                gameState.round = state.round || 1;
                gameState.eliminatedPlayers = state.eliminatedPlayers || [];
                
                updatePhaseDisplay(gameState.phase);
                document.getElementById('currentRound').textContent = gameState.round;
            });
            
            // Active players
            database.ref('finals/activePlayers').on('value', (snapshot) => {
                gameState.activePlayers = snapshot.val() || {};
                updatePlayerDisplay();
            });
            
            // Phone assignments
            database.ref('finals/currentRound/phoneAssignments').on('value', (snapshot) => {
                gameState.phoneAssignments = snapshot.val() || {};
                updatePhoneAssignments();
            });
            
            // Player selections
            database.ref('finals/currentRound/playerSelections').on('value', (snapshot) => {
                gameState.playerSelections = snapshot.val() || {};
                updateSelectionTracking();
                updatePlayerDisplay();
            });
            
            // Reveal results
            database.ref('finals/currentRound/revealResults').on('value', (snapshot) => {
                gameState.revealResults = snapshot.val();
                updatePlayerDisplay();
            });
            
            // Opted out players
            database.ref('finals/currentRound/optedOut').on('value', (snapshot) => {
                gameState.optedOut = snapshot.val() || {};
            });
            
            // Fighting players
            database.ref('finals/currentRound/fightingPlayers').on('value', (snapshot) => {
                gameState.fightingPlayers = snapshot.val() || [];
            });
            
            // Battle matchups
            database.ref('finals/currentRound/battleMatchups').on('value', (snapshot) => {
                gameState.battleMatchups = snapshot.val() || {};
                updateMatchupDisplay();
            });
            
            // Challenges
            database.ref('finals/challenges').on('value', (snapshot) => {
                const challenges = snapshot.val() || {};
                gameState.challenges = Object.values(challenges);
                updateChallengeDisplay();
            });
            
            // Founder wealth
            database.ref('game/founderWealth').on('value', (snapshot) => {
                gameState.founderWealth = snapshot.val() || {};
                updatePlayerDisplay();
            });
            
            // Custom players
            database.ref('finals/customPlayers').on('value', (snapshot) => {
                const customPlayers = snapshot.val() || {};
                
                // Add custom players to eligible founders if not already there
                Object.values(customPlayers).forEach(player => {
                    if (!eligibleFounders.find(f => f.id === player.id)) {
                        eligibleFounders.push(player);
                    }
                });
            });
        }

        // Initialize
        window.onload = () => {
            setupListeners();
            
            // Initialize game state if needed
            database.ref('finals/gameState').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    database.ref('finals/gameState').set({
                        phase: 'waiting',
                        round: 1,
                        eliminatedPlayers: []
                    });
                }
            });
            
            // Add some default challenges
            const defaultChallenges = [
                "Speed pitch your worst startup idea - most cringe wins",
                "Create a startup jingle using only mouth sounds",
                "Act out your business model through interpretive dance",
                "Roast battle: Destroy each other's business plans",
                "Startup charades - act out famous company failures",
                "Elevator pitch while doing pushups - best pitch wins",
                "Draw your startup logo blindfolded - most recognizable wins",
                "Rap battle about your business model",
                "Human PowerPoint - act out your pitch deck",
                "Startup spelling bee with tech buzzwords"
            ];
            
            database.ref('finals/challenges').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    defaultChallenges.forEach((desc, index) => {
                        const id = `default_${index}`;
                        database.ref(`finals/challenges/${id}`).set({
                            id: id,
                            description: desc,
                            active: true
                        });
                    });
                }
            });
            
            log('Finals Moderator initialized', 'success');
        };
    </script>
</body>
</html>