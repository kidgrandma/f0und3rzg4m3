<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F0UND3RZ G4M3 - Moderator Control (CLEANED)</title>
    <style>
        /* CSS VARIABLES */
        :root {
            --purple: #8A2BE2;
            --cyan: #00FFFF;
            --yellow: #FFFF00;
            --pink: #FF69B4;
            --team1-color: #DC143C;
            --team2-color: #00BFFF;
            --glass-dark: rgba(0,0,0,0.85);
            --glass-light: rgba(0,0,0,0.7);
            --blur: 10px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            color: #fff;
            padding: 20px;
            min-height: 100vh;
            position: relative;
        }

        .liminal-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background-color: #000;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .header {
            background: transparent;
            padding: 15px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 3px solid #fff;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 20px rgba(255,255,255,0.5), 3px 3px 0 #000;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--cyan);
            font-size: 1.2em;
            text-shadow: 0 0 10px var(--cyan);
        }

        .controls {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .panel {
            background: var(--glass-dark);
            backdrop-filter: blur(var(--blur));
            border: 3px solid rgba(255,255,255,0.4);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }

        .panel h2 {
            color: var(--cyan);
            margin-bottom: 20px;
            font-size: 1.8em;
            text-shadow: 0 0 10px var(--cyan);
            font-weight: 700;
        }

        .priority-panel {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .team-panel {
            background: var(--glass-dark);
            border: 3px solid;
            border-radius: 15px;
            padding: 20px;
        }

        .team-panel.team-1 {
            border-color: var(--team1-color);
            background: rgba(220,20,60,0.1);
        }

        .team-panel.team-2 {
            border-color: var(--team2-color);
            background: rgba(0,191,255,0.1);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .team-name {
            font-size: 1.4em;
            font-weight: bold;
        }

        .team-1 .team-name {
            color: var(--team1-color);
            text-shadow: 0 0 10px var(--team1-color);
        }

        .team-2 .team-name {
            color: var(--team2-color);
            text-shadow: 0 0 10px var(--team2-color);
        }

        .team-valuation {
            font-size: 2em;
            color: var(--yellow);
            font-weight: 900;
            text-shadow: 0 0 15px var(--yellow);
        }

        .founder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .founder-item {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .founder-item:hover {
            background: rgba(255,255,255,0.1);
            transform: scale(1.05);
        }

        .founder-item.active {
            border-color: var(--yellow);
            background: rgba(255,255,0,0.2);
        }

        .founder-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 5px;
            display: block;
        }

        .founder-name {
            font-size: 0.8em;
            line-height: 1.2;
        }

        .founder-wealth {
            font-size: 0.9em;
            color: var(--yellow);
            font-weight: bold;
            margin-top: 3px;
        }

        .current-card {
            background: rgba(255,255,0,0.1);
            border: 3px solid var(--yellow);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .current-card.no-card {
            background: rgba(100,100,100,0.1);
            border-color: #666;
        }

        .current-card h3 {
            color: var(--yellow);
            font-size: 1.4em;
            margin-bottom: 15px;
            text-shadow: 0 0 10px var(--yellow);
        }

        .challenge-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
        }

        .progress-text {
            font-size: 1.1em;
        }

        .progress-bar {
            flex: 1;
            height: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            margin: 0 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--cyan), var(--yellow));
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        .challenge-item {
            background: rgba(0,0,0,0.8);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .challenge-item.completed {
            opacity: 0.6;
            border-color: #00ff00;
            background: rgba(0,255,0,0.1);
        }

        .challenge-item.pending {
            border-color: var(--yellow);
            background: rgba(255,255,0,0.1);
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .challenge-value {
            color: var(--yellow);
            font-weight: bold;
            font-size: 1.2em;
        }

        .challenge-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-available {
            background: var(--cyan);
            color: #000;
        }

        .status-completed {
            background: #00ff00;
            color: #000;
        }

        .challenge-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }

        .undo-button {
            background: var(--purple);
            color: white;
            padding: 5px 10px;
            font-size: 0.8em;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .undo-button:hover {
            background: var(--pink);
            transform: scale(1.05);
        }

        .pending-selection {
            background: rgba(0,0,0,0.9);
            border: 3px solid var(--yellow);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0% { border-color: var(--yellow); }
            50% { border-color: var(--pink); }
            100% { border-color: var(--yellow); }
        }

        .pending-selection h3 {
            color: var(--yellow);
            margin-bottom: 15px;
            text-shadow: 0 0 10px var(--yellow);
            font-size: 1.4em;
        }

        .value-editor-section {
            background: rgba(0,0,0,0.7);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .value-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .value-editor-header:hover {
            background: rgba(255,255,255,0.1);
        }

        .value-editor-header h4 {
            color: var(--yellow);
            font-size: 1.5em;
            text-shadow: 0 0 10px var(--yellow);
        }

        .expand-icon {
            font-size: 1.5em;
            color: var(--cyan);
            transition: transform 0.3s ease;
        }

        .value-editor-header.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .value-challenges {
            display: none;
            margin-top: 15px;
        }

        .value-challenges.show {
            display: block;
        }

        .challenge-input-group {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .challenge-input-label {
            color: var(--cyan);
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
            font-size: 0.9em;
        }

        input, textarea, select {
            background: rgba(0,0,0,0.9);
            border: 2px solid var(--cyan);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-family: Arial;
            width: 100%;
            margin-bottom: 10px;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--yellow);
            box-shadow: 0 0 10px rgba(255,255,0,0.3);
        }

        button {
            background: var(--cyan);
            color: #000;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            font-family: 'Arial', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0,255,255,0.3);
        }

        button:hover {
            background: var(--yellow);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(255,255,0,0.4);
        }

        button.danger {
            background: #ff3333;
            color: white;
            box-shadow: 0 4px 15px rgba(255,51,51,0.3);
        }

        button.secondary {
            background: var(--purple);
            color: white;
            box-shadow: 0 4px 15px rgba(138,43,226,0.3);
        }

        button.success {
            background: #00ff00;
            color: #000;
            box-shadow: 0 4px 15px rgba(0,255,0,0.3);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .compact-panel {
            background: rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 15px;
        }

        .compact-panel h3 {
            color: var(--cyan);
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.online {
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }

        .status-indicator.offline {
            background: #ff3333;
            box-shadow: 0 0 10px #ff3333;
        }

        .log {
            background: rgba(0,0,0,0.9);
            border: 2px solid rgba(255,255,255,0.3);
            padding: 15px;
            border-radius: 12px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9em;
            margin-top: 20px;
        }

        .log-entry {
            color: #ccc;
            margin-bottom: 5px;
            font-family: monospace;
            line-height: 1.3;
        }

        .log-entry.success {
            color: var(--cyan);
        }

        .log-entry.error {
            color: #ff3333;
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
            
            .priority-panel {
                grid-template-columns: 1fr;
            }
            
            .founder-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }

            .header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="liminal-bg"></div>

    <div class="header">
        <h1>üéÆ MODERATOR CONTROL üéÆ</h1>
        <p>Round-by-round game management</p>
    </div>

    <div class="controls">
        <!-- PRIORITY: TEAM MANAGEMENT -->
        <div class="priority-panel">
            <div class="team-panel team-1">
                <div class="team-header">
                    <div class="team-name">üî¥ Y2KET CORP.</div>
                    <div class="team-valuation" id="valuation1">$0</div>
                </div>
                <div class="founder-grid" id="team1Founders">
                    <div style="color: #666; text-align: center; grid-column: 1/-1;">Click "Import Founders" to load teams</div>
                </div>
                <div class="button-group" style="margin-top: 15px;">
                    <button onclick="loadFoundersFromCompaniesPage()" class="secondary">üì• Import Founders</button>
                    <button onclick="addNewFounder()" class="secondary">‚ûï Add Founder</button>
                </div>
            </div>

            <div class="team-panel team-2">
                <div class="team-header">
                    <div class="team-name">üîµ SERIES A(POCALYPSE)</div>
                    <div class="team-valuation" id="valuation2">$0</div>
                </div>
                <div class="founder-grid" id="team2Founders">
                    <div style="color: #666; text-align: center; grid-column: 1/-1;">Click "Import Founders" to load teams</div>
                </div>
                <div class="button-group" style="margin-top: 15px;">
                    <button onclick="setActiveCompany(1)">‚Üê Set Active</button>
                    <button onclick="setActiveCompany(2)">Set Active ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- CURRENT CARD & CHALLENGES -->
        <div class="panel">
            <h2>üéØ Current Card & Challenges</h2>
            
            <div id="pendingSelection">
                <div class="current-card no-card">
                    <h3>‚è≥ Waiting for Team Selection</h3>
                    <p style="color: #666;">No category selected yet. Waiting for teams to choose...</p>
                </div>
            </div>
            <div id="activeCard" style="display: none;">
                <div class="current-card">
                    <h3 id="currentCardTitle">Current Card</h3>
                    <div class="challenge-progress">
                        <span class="progress-text" id="progressText">0/5 Completed</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <span id="remainingChallenges">5 Left</span>
                    </div>
                </div>
                
                <div id="challengeList"></div>
                <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,0,0.1); border: 2px solid var(--yellow); border-radius: 10px;">
                    <button id="scoringModeBtn" onclick="toggleScoringMode()" class="secondary" style="width: 100%;">
                        üè¢ MODE: TEAM + PERSONAL
                    </button>
                    <div id="scoringModeIndicator" style="display: none; margin-top: 10px; color: var(--yellow); text-align: center; font-weight: bold;">
                        ‚ö†Ô∏è PERSONAL MODE: Points go to founders only, NOT to teams!
                    </div>
                </div>
                
                <div class="button-group" style="margin-top: 20px;">
                    <button onclick="closeCurrentCard()" class="danger">üèÅ Close Card</button>
                    <button onclick="cancelCurrentRound()" class="danger">‚ùå Cancel Round</button>
                    <button onclick="nextTeamTurn()" class="secondary">üë• Next Team's Turn</button>
                </div>
            </div>
        </div>

        <!-- ENHANCED CHALLENGE EDITOR -->
        <div class="panel">
            <h2>üìù Edit Challenges</h2>
            
            <div class="compact-panel">
                <h3>Select Category to Edit</h3>
                <select id="editCategorySelect" onchange="loadChallengesForEdit()" style="width: 100%; margin-bottom: 20px;">
                    <option value="">Choose Category...</option>
                    <option value="meme-me-up-scottie">Meme Me Up Scottie</option>
                    <option value="doom-scroll-nation">Doom Scroll Nation</option>
                    <option value="web-1.0">Web 1.0</option>
                    <option value="netbangerz">Netbangerz</option>
                    <option value="paizley-and-robot">Paizley and Robot</option>
                    <option value="em0ti0nz">Em0ti0nz</option>
                </select>
                
                <div id="challengeEditor" style="display: none;">
                    <div id="challengeInputs"></div>
                    <button onclick="saveChallenges()" class="success" style="width: 100%; margin-top: 15px;">üíæ Save All Challenges</button>
                </div>
            </div>
        </div>

        <!-- BOTTOM: UTILITIES -->
        <div class="panel compact-panel">
            <h2>üîß Game Utilities</h2>
            <div class="quick-actions">
                <button onclick="pauseGame()" class="secondary">‚è∏Ô∏è Pause Game</button>
                <button onclick="resumeGame()" class="secondary">‚ñ∂Ô∏è Resume Game</button>
                <button onclick="openFirebaseDiagnostic()" class="secondary">üîç Firebase Diagnostic</button>
                <button onclick="openScoreEditor()" class="secondary">‚úèÔ∏è Edit Scores</button>
                <button onclick="openChallengeWinnerEditor()" class="secondary">üèÜ Edit Challenge Winners</button>
                <button onclick="clearStaleData()" class="secondary">üßπ Clear Stale</button>
                <button onclick="resetValuations()" class="danger">üí∞ Reset Scores</button>
                <button onclick="openWalletRecovery()" class="secondary">üí∏ Wallet Recovery Tool</button>
                <button onclick="openIndividualWallet()" class="secondary">üí≥ Individual Wallets</button>
                <button onclick="ensureAllFoundersInFirebase()" class="secondary">üîÑ Sync All Founders</button>
                <button onclick="verifyFounderWealth()" class="secondary">üîç Verify Wallets</button>
                <button onclick="resetAll()" class="danger">üîÑ Reset Everything</button>
            </div>
        </div>

        <!-- BOTTOM: CONNECTION STATUS -->
        <div class="panel compact-panel">
            <h2>üì° Connection Status</h2>
            <p><span class="status-indicator offline" id="firebaseStatus"></span>Firebase: <span id="connectionText">Connecting...</span></p>
            <p><span class="status-indicator offline" id="gameStatus"></span>Game: <span id="gameStateText">Initializing...</span></p>
            <div class="log" id="gameLog"></div>
        </div>
    </div>

    <!-- INDIVIDUAL WALLET MODAL -->
    <div id="individualWalletModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; overflow-y: auto; padding: 20px;">
        <div style="max-width: 1200px; margin: 0 auto; background: #1a1a1a; border-radius: 20px; padding: 30px; border: 3px solid var(--cyan);">
            <h2 style="color: var(--cyan); margin-bottom: 20px;">üí≥ INDIVIDUAL WALLET MANAGER</h2>
            
            <div style="display: grid; grid-template-columns: 300px 1fr; gap: 30px;">
                <!-- Founder List -->
                <div style="background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.3); border-radius: 15px; padding: 20px; max-height: 600px; overflow-y: auto;">
                    <h3 style="color: var(--yellow); margin-bottom: 15px;">Select Founder</h3>
                    <div id="walletFounderList"></div>
                </div>
                
                <!-- Wallet Details -->
                <div id="walletDetails" style="display: none;">
                    <div style="background: rgba(0,0,0,0.7); border: 2px solid var(--purple); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 20px;">
                            <img id="walletFounderImage" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--cyan);">
                            <div>
                                <h3 id="walletFounderName" style="color: var(--cyan); margin-bottom: 5px;"></h3>
                                <div id="walletFounderHandle" style="color: var(--yellow); font-size: 14px;"></div>
                                <div id="walletFounderWealth" style="color: var(--yellow); font-size: 24px; font-weight: bold; margin-top: 5px;"></div>
                            </div>
                        </div>
                        
                        <!-- Add Money Section -->
                        <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                            <h4 style="color: var(--pink); margin-bottom: 10px;">Add Money</h4>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <input type="number" id="customAmount" placeholder="Custom amount" style="flex: 1;">
                                <button onclick="addCustomAmount()" class="success">Add Custom</button>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="addQuickAmount(100)">+$100</button>
                                <button onclick="addQuickAmount(200)">+$200</button>
                                <button onclick="addQuickAmount(300)">+$300</button>
                                <button onclick="addQuickAmount(500)">+$500</button>
                                <button onclick="addQuickAmount(1000)">+$1000</button>
                            </div>
                        </div>
                        
                        <!-- Achievements Section -->
                        <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px;">
                            <h4 style="color: var(--pink); margin-bottom: 15px;">Completed Challenges</h4>
                            <div id="walletAchievements" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <button onclick="closeIndividualWallet()" style="margin-top: 20px; background: var(--pink); color: white;">Close Wallet Manager</button>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDnHE2Ay2wqZVC4Xf2PsHHppVoVfNPk0hI",
            authDomain: "f0und3rzg4m3-b04rd.firebaseapp.com",
            databaseURL: "https://f0und3rzg4m3-b04rd-default-rtdb.firebaseio.com",
            projectId: "f0und3rzg4m3-b04rd",
            storageBucket: "f0und3rzg4m3-b04rd.firebasestorage.app",
            messagingSenderId: "484982613831",
            appId: "1:484982613831:web:9b655b3d66d66b3b5e8e62",
            measurementId: "G-MPN2LP1Q6X"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Game state
        let currentCompanies = { 1: { valuation: 0 }, 2: { valuation: 0 } };
        let currentTeam = 1;
        let pendingSelection = null;
        let activeChallenges = null;
        let isConnected = false;
        let selectedFounder = null;
        let founderWealth = {};
        let personalScoringMode = false;
        let selectedWalletFounder = null;

        // Enhanced challenge database with actual challenges
        let challengeDatabase = {
            "meme-me-up-scottie": {
                100: [
                    { description: "Create a startup pitch using only meme formats", value: 100 },
                    { description: "Explain blockchain using only cat memes", value: 100 },
                    { description: "Pitch your company as a 'Woman yelling at cat' meme", value: 100 },
                    { description: "Describe your product using the Drake format", value: 100 },
                    { description: "Make a 'This is Fine' meme about your burn rate", value: 100 }
                ],
                200: [
                    { description: "Turn your biggest failure into a viral meme template", value: 200 },
                    { description: "Create a meme explaining why VCs should fund you", value: 200 },
                    { description: "Make a 'Distracted Boyfriend' meme about pivoting", value: 200 },
                    { description: "Design a meme NFT collection for your startup", value: 200 },
                    { description: "Create a meme that explains Web3 to boomers", value: 200 }
                ]
            },
            "doom-scroll-nation": {
                100: [
                    { description: "Tweet your entire business model in one thread", value: 100 },
                    { description: "Create a viral TikTok about venture capital", value: 100 },
                    { description: "Design an Instagram story to announce bankruptcy", value: 100 },
                    { description: "Make a LinkedIn post about pivoting that gets 10K reactions", value: 100 },
                    { description: "Create a Twitter spaces about your failed startup", value: 100 }
                ],
                200: [
                    { description: "Go viral on BeReal with authentic startup content", value: 200 },
                    { description: "Create a doomscrolling addiction recovery app pitch", value: 200 },
                    { description: "Design a social media detox retreat for founders", value: 200 },
                    { description: "Make a TikTok dance about your burn rate", value: 200 },
                    { description: "Create an influencer marketing campaign using only bots", value: 200 }
                ]
            },
            "web-1.0": {
                100: [
                    { description: "Design a GeoCities page for your startup", value: 100 },
                    { description: "Create an ASCII art logo for your company", value: 100 },
                    { description: "Write a business plan using only Comic Sans", value: 100 },
                    { description: "Make a Flash intro for your product launch", value: 100 },
                    { description: "Design a banner ad that auto-plays music", value: 100 }
                ],
                200: [
                    { description: "Build a MySpace Top 8 for your cap table", value: 200 },
                    { description: "Create a Webring for failed startups", value: 200 },
                    { description: "Design a visitor counter that tracks your runway", value: 200 },
                    { description: "Make an animated GIF email signature", value: 200 },
                    { description: "Create a MIDI theme song for your startup", value: 200 }
                ]
            },
            "netbangerz": {
                100: [
                    { description: "Compose a startup jingle using Windows XP sounds", value: 100 },
                    { description: "Create a dial-up modem symphony about funding", value: 100 },
                    { description: "Make a ringtone that says your elevator pitch", value: 100 },
                    { description: "Record a voicemail greeting for your failed startup", value: 100 },
                    { description: "Create a notification sound for getting rejected by VCs", value: 100 }
                ],
                200: [
                    { description: "Produce a lo-fi hip hop track about burnout", value: 200 },
                    { description: "Create a podcast intro using only error sounds", value: 200 },
                    { description: "Make a Clubhouse room with just breathing sounds", value: 200 },
                    { description: "Design an ASMR video about term sheets", value: 200 },
                    { description: "Record a sea shanty about technical debt", value: 200 }
                ]
            },
            "paizley-and-robot": {
                100: [
                    { description: "Act out a conversation between you and ChatGPT about your startup", value: 100 },
                    { description: "Pretend to be an AI explaining why humans are obsolete", value: 100 },
                    { description: "Role-play debugging your life like it's code", value: 100 },
                    { description: "Perform a TED talk as a malfunctioning robot", value: 100 },
                    { description: "Act out Siri and Alexa arguing about your business model", value: 100 }
                ],
                200: [
                    { description: "Perform interpretive dance about machine learning", value: 200 },
                    { description: "Act out your startup's death by AI replacement", value: 200 },
                    { description: "Role-play as a VC who's actually three AIs in a trenchcoat", value: 200 },
                    { description: "Demonstrate your product using only robot noises", value: 200 },
                    { description: "Perform a one-person show about the singularity", value: 200 }
                ]
            },
            "em0ti0nz": {
                100: [
                    { description: "Express your funding journey using only emojis", value: 100 },
                    { description: "Create an emoji-only pitch deck", value: 100 },
                    { description: "Tell the story of your startup's pivot in 10 emojis", value: 100 },
                    { description: "Design an emoji logo for your company", value: 100 },
                    { description: "Write your resignation letter entirely in emojis", value: 100 }
                ],
                200: [
                    { description: "Create an emoji-based programming language", value: 200 },
                    { description: "Design an emoji term sheet template", value: 200 },
                    { description: "Build an emoji mood ring for founder mental health", value: 200 },
                    { description: "Make an emoji-only investor update", value: 200 },
                    { description: "Create an emoji astrology chart for startups", value: 200 }
                ]
            }
        };

        // Founders database
        let foundersDatabase = {
            1: [],
            2: []
        };

        // Connection status updates
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const statusEl = document.getElementById('firebaseStatus');
            const textEl = document.getElementById('connectionText');
            
            if (connected) {
                statusEl.className = 'status-indicator online';
                textEl.textContent = 'Connected';
            } else {
                statusEl.className = 'status-indicator offline';
                textEl.textContent = 'Disconnected';
            }
        }

        function updateGameStatus(status) {
            const statusEl = document.getElementById('gameStatus');
            const textEl = document.getElementById('gameStateText');
            
            statusEl.className = 'status-indicator online';
            textEl.textContent = status;
        }

        // Logging
        function log(message, type = 'normal') {
            const logDiv = document.getElementById('gameLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Load random background
        function loadRandomBackground() {
            const backgrounds = [
                { file: 'game-bg-1.jpg', weight: 3 },
                { file: 'game-bg-2.jpg', weight: 3 },
                { file: 'game-bg-3.jpg', weight: 2 },
                { file: 'game-bg-4.jpg', weight: 1 },
                { file: 'game-bg-5.jpg', weight: 1 }
            ];
            
            const totalWeight = backgrounds.reduce((sum, bg) => sum + bg.weight, 0);
            let random = Math.random() * totalWeight;
            let selectedBg = backgrounds[0].file;
            
            for (const bg of backgrounds) {
                random -= bg.weight;
                if (random <= 0) {
                    selectedBg = bg.file;
                    break;
                }
            }
            
            const liminalBg = document.querySelector('.liminal-bg');
            liminalBg.style.backgroundImage = `url('assets/backgrounds/${selectedBg}')`;
        }

        // FIXED: Load founders with ALL 41 including missing ones
        function loadFoundersFromCompaniesPage() {
            database.ref('game/founderWealth').once('value', (snapshot) => {
                const existingWealth = snapshot.val() || {};
                
                const hardcodedFounders = {
                    1: [
                        { id: '45_sean_rad', name: 'Sean Rad', company: 'Tinder', image: '45_sean_rad.png', team: 1, handle: '@[NEED_HANDLE]' },
                        { id: '30_john_mckafee', name: 'John McAfee', company: 'McAfee', image: '30_john_mckafee.png', team: 1, handle: '@hauntyourownhouse' },
                        { id: '13_jensen_huang', name: 'Jensen Huang', company: 'NVIDIA', image: '13_jensen_huang.png', team: 1, handle: '@destoryerofspacegalaxy9000' },
                        { id: '22_pavel_durov', name: 'Pavel Durov', company: 'Telegram', image: '22_pavel_durov.png', team: 1, handle: '@discoesq' },
                        { id: '32_kevin_systrom', name: 'Kevin Systrom', company: 'Instagram', image: '32_kevin_systrom.png', team: 1, handle: '@dougdalton' },
                        { id: '35_tom_anderson', name: 'Tom Anderson', company: 'MySpace', image: '35_tom_anderson.png', team: 1, handle: '@betwixt.frankie' },
                        { id: '40_craig_newmark', name: 'Craig Newmark', company: 'Craigslist', image: '40_craig_newmark.png', team: 1, handle: '@ladyhuss_' },
                        { id: '20_jack_dorsey', name: 'Jack Dorsey', company: 'Twitter', image: '20_jack_dorsey.png', team: 1, handle: '@jackhite' },
                        { id: '50_jessica_alba', name: 'Jessica Alba', company: 'The Honest Company', image: '50_jessica_alba.png', team: 1, handle: '@jasche__' },
                        { id: '14_peter_thiel', name: 'Peter Thiel', company: 'Palantir', image: '14_peter_thiel.png', team: 1, handle: '@jesushands' },
                        { id: '17_sam_altman', name: 'Sam Altman', company: 'OpenAI', image: '17_sam_altman.png', team: 1, handle: '@michaelmelwani' },
                        { id: '11_google_founders', name: 'Larry Page & Sergey Brin', company: 'Google', image: '11_google_founders.png', team: 1, handle: '@mfgarret + @nataliesomekh_' },
                        { id: '15_jack_ma', name: 'Jack Ma', company: 'Alibaba', image: '15_jack_ma.png', team: 1, handle: '@manolowashere' },
                        { id: '08_elon_musk', name: 'Elon Musk', company: 'Tesla/SpaceX', image: '08_elon_musk.png', team: 1, handle: '@vishaal.arya' },
                        { id: '19_vitalik_buterin', name: 'Vitalik Buterin', company: 'Ethereum', image: '19_vitalik_buterin.png', team: 1, handle: '@saulisgood' },
                        { id: '29_sean_parker', name: 'Sean Parker', company: 'Napster', image: '29_sean_parker.png', team: 1, handle: '@mansweater' },
                        { id: '41_lucy_guo', name: 'Lucy Guo', company: 'Scale AI', image: '41_lucy_guo.png', team: 1, handle: '@literatrix' },
                        { id: '06_brian_chesky', name: 'Brian Chesky', company: 'Airbnb', image: '06_brian_chesky.png', team: 1, handle: '@cyborgdrew' },
                        { id: '52_palmer_luckey', name: 'Palmer Luckey', company: 'Oculus', image: '52_palmer_luckey.png', team: 1, handle: '@spine.remover' },
                        { id: '38_juul', name: 'James Monsees & Adam Bowen', company: 'Juul', image: '38_juul.png', team: 1, handle: '@sam__stiles' },
                        { id: '63_winklevoss', name: 'Winklevoss Twins', company: 'Gemini', image: '63_winklevoss.png', team: 1, handle: '@whoiskaybrown' },
                        { id: '67_kim', name: 'Kim Dotcom', company: 'Mega', image: '67_kim.png', team: 1, handle: '@thecornii' }
                    ],
                    2: [
                        { id: '28_adam_neumann', name: 'Adam Neumann', company: 'WeWork', image: '28_adam_neumann.png', team: 2, handle: '@[NEED_HANDLE]' },
                        { id: '51_zhang_yiming', name: 'Zhang Yiming', company: 'ByteDance', image: '51_zhang_yiming.png', team: 2, handle: '@aiiisound' },
                        { id: '34_meg_whitman', name: 'Meg Whitman', company: 'eBay', image: '34_meg_whitman.png', team: 2, handle: '@bombchips' },
                        { id: '04_brian_armstrong', name: 'Brian Armstrong', company: 'Coinbase', image: '04_brian_armstrong.png', team: 2, handle: '@jenergizer' },
                        { id: '48_sam_bankman_fried', name: 'Sam Bankman-Fried', company: 'FTX', image: '48_sam_bankman-fried.png', team: 2, handle: '@teamcoben' },
                        { id: '49_reed_hastings', name: 'Reed Hastings', company: 'Netflix', image: '49_reed_hastings.png', team: 2, handle: '@stan_jericho', status: 'dead' },
                        { id: '24_larry_ellison', name: 'Larry Ellison', company: 'Oracle', image: '24_larry_ellison.png', team: 2, handle: '@littleurbanachiever' },
                        { id: '21_jimmy_wales', name: 'Jimmy Wales', company: 'Wikipedia', image: '21_jimmy_wales.png', team: 2, handle: '@danieldomange' },
                        { id: '46_dread_pirate', name: 'Ross Ulbricht', company: 'Silk Road', image: '46_dread_pirate.png', team: 2, handle: '@octavekitten' },
                        { id: '25_elizabeth_holmes', name: 'Elizabeth Holmes', company: 'Theranos', image: '25_elizabeth_holmes.png', team: 2, handle: '@seanpaulsartre_' },
                        { id: '47_daniel_ek', name: 'Daniel Ek', company: 'Spotify', image: '47_daniel_ek.png', team: 2, handle: '@jacquesgreene' },
                        { id: '27_travis_kalanick', name: 'Travis Kalanick', company: 'Uber', image: '27_travis_kalanick.png', team: 2, handle: '@kunaalarya' },
                        { id: '37_steve_wozniak', name: 'Steve Wozniak', company: 'Apple', image: '37_steve_wozniak.png', team: 2, handle: '@minibearbeats' },
                        { id: '53_youtube', name: 'YouTube Founders', company: 'YouTube', image: '53_youtube.png', team: 2, handle: '@plascu' },
                        { id: '31_whitney_wolfe_herd', name: 'Whitney Wolfe Herd', company: 'Bumble', image: '31_whitney_wolfe_herd.png', team: 2, handle: '@steak.night' },
                        { id: '36_alexis_ohanian', name: 'Alexis Ohanian', company: 'Reddit', image: '36_alexis_ohanian.png', team: 2, handle: '@taytaystay' },
                        { id: '43_sophia_amoruso', name: 'Sophia Amoruso', company: 'Nasty Gal', image: '43_sophia_amoruso.png', team: 2, handle: '@special_agent_long' },
                        { id: '39_ariana_huffington', name: 'Ariana Huffington', company: 'Huffington Post', image: '39_ariana_huffington.png', team: 2, handle: '@jubileedj' },
                        { id: '33_martin_shkreli', name: 'Martin Shkreli', company: 'Turing Pharmaceuticals', image: '33_martin_shkreli.png', team: 2, handle: '@l2ex', status: 'dead' }
                    ]
                };
                
                foundersDatabase = hardcodedFounders;
                
                // Initialize founder wealth, preserving existing values
                founderWealth = {};
                let preservedCount = 0;
                let newCount = 0;
                
                Object.values(foundersDatabase).flat().forEach(founder => {
                    if (existingWealth[founder.id] !== undefined && existingWealth[founder.id] > 0) {
                        founderWealth[founder.id] = existingWealth[founder.id];
                        preservedCount++;
                    } else {
                        founderWealth[founder.id] = 0;
                        newCount++;
                    }
                });
                
                database.ref('game/founders').set(foundersDatabase);
                database.ref('game/founderWealth').set(founderWealth);
                updateFounderDisplay();
                
                log(`Imported ${Object.values(foundersDatabase).flat().length} founders: ${preservedCount} kept wealth, ${newCount} at $0`, 'success');
                
                // Auto-ensure all founders are synced
                setTimeout(ensureAllFoundersInFirebase, 1000);
            });
        }

        // Ensure all founders exist in Firebase
        function ensureAllFoundersInFirebase() {
            console.log('Ensuring all founders are in Firebase...');
            
            const allFounders = [...(foundersDatabase[1] || []), ...(foundersDatabase[2] || [])];
            
            if (allFounders.length === 0) {
                alert('Please click "Import Founders" first!');
                return;
            }
            
            database.ref('game/founderWealth').once('value', (snapshot) => {
                const currentWealth = snapshot.val() || {};
                let updates = false;
                let addedCount = 0;
                
                allFounders.forEach(founder => {
                    if (!(founder.id in currentWealth)) {
                        currentWealth[founder.id] = 0;
                        updates = true;
                        addedCount++;
                        console.log(`Adding missing founder: ${founder.name} (${founder.id})`);
                    }
                });
                
                if (updates) {
                    database.ref('game/founderWealth').set(currentWealth)
                        .then(() => {
                            console.log(`‚úÖ Added ${addedCount} missing founders to Firebase!`);
                            log(`‚úÖ Added ${addedCount} missing founders to Firebase`, 'success');
                            founderWealth = currentWealth;
                            updateFounderDisplay();
                        });
                } else {
                    console.log('‚úÖ All founders already in Firebase');
                    log('‚úÖ All 41 founders already tracked', 'success');
                }
            });
        }

        // Verify founder wealth status
        function verifyFounderWealth() {
            console.log('üìä FOUNDER WEALTH VERIFICATION');
            
            const allFounders = [...(foundersDatabase[1] || []), ...(foundersDatabase[2] || [])];
            
            database.ref('game/founderWealth').once('value', (snapshot) => {
                const wealthData = snapshot.val() || {};
                
                const foundersWithWealth = [];
                const foundersWithoutWealth = [];
                
                allFounders.forEach(founder => {
                    if (wealthData[founder.id] !== undefined) {
                        foundersWithWealth.push({
                            name: founder.name,
                            id: founder.id,
                            team: founder.team,
                            wealth: wealthData[founder.id]
                        });
                    } else {
                        foundersWithoutWealth.push({
                            name: founder.name,
                            id: founder.id,
                            team: founder.team
                        });
                    }
                });
                
                foundersWithWealth.sort((a, b) => b.wealth - a.wealth);
                
                console.log(`\nTotal Founders: ${allFounders.length}`);
                console.log(`With Wealth: ${foundersWithWealth.length}`);
                console.log(`Without Wealth: ${foundersWithoutWealth.length}`);
                
                if (foundersWithoutWealth.length > 0) {
                    const message = `Found ${foundersWithoutWealth.length} founders without wealth entries:\n\n` +
                        foundersWithoutWealth.map(f => `‚Ä¢ ${f.name} (Team ${f.team})`).join('\n') +
                        '\n\nClick "Sync All Founders" to fix this!';
                    alert(message);
                } else {
                    alert(`‚úÖ All ${allFounders.length} founders have wealth entries!`);
                }
            });
        }

        function updateFounderDisplay() {
            const team1Div = document.getElementById('team1Founders');
            const team2Div = document.getElementById('team2Founders');
            
            team1Div.innerHTML = renderFounderTeam(foundersDatabase[1] || [], 1);
            team2Div.innerHTML = renderFounderTeam(foundersDatabase[2] || [], 2);
        }

        function renderFounderTeam(founders, teamNum) {
            if (founders.length === 0) {
                return '<div style="color: #666; text-align: center; grid-column: 1/-1;">No founders assigned</div>';
            }
            
            return founders.map(founder => `
                <div class="founder-item ${founder.status === 'dead' ? 'dead' : ''}" onclick="selectFounder('${founder.id}')" data-founder="${founder.id}">
                    <img src="assets/founders/${founder.image}" alt="${founder.name}" class="founder-avatar" 
                         onerror="this.src='assets/founders/default.png'">
                    <div class="founder-name">${founder.name}</div>
                    <div style="font-size: 0.7em; color: var(--cyan); margin-top: 2px;">${founder.handle || ''}</div>
                    <div class="founder-wealth">$${(founderWealth[founder.id] || 0).toLocaleString()}</div>
                    <button onclick="moveFounderToOtherTeam('${founder.id}'); event.stopPropagation();" 
                            style="position: absolute; top: 2px; right: 2px; background: var(--purple); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7em; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        ‚Üî
                    </button>
                </div>
            `).join('');
        }

        function selectFounder(founderId) {
            document.querySelectorAll('.founder-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const founderElement = document.querySelector(`[data-founder="${founderId}"]`);
            if (founderElement) {
                founderElement.classList.add('active');
                selectedFounder = founderId;
                
                const founder = [...(foundersDatabase[1] || []), ...(foundersDatabase[2] || [])].find(f => f.id === founderId);
                if (founder) {
                    log(`Selected: ${founder.name}`, 'success');
                }
            }
        }

        function moveFounderToOtherTeam(founderId) {
            let founder = null;
            let currentTeam = null;
            
            for (let team in foundersDatabase) {
                const index = foundersDatabase[team].findIndex(f => f.id === founderId);
                if (index !== -1) {
                    founder = foundersDatabase[team][index];
                    currentTeam = parseInt(team);
                    foundersDatabase[team].splice(index, 1);
                    break;
                }
            }
            
            if (founder) {
                const newTeam = currentTeam === 1 ? 2 : 1;
                founder.team = newTeam;
                foundersDatabase[newTeam].push(founder);
                
                database.ref('game/founders').set(foundersDatabase);
                updateFounderDisplay();
                log(`Moved ${founder.name} to Team ${newTeam}`, 'success');
            }
        }

        function addNewFounder() {
            const name = prompt('Enter founder name:');
            if (!name) return;
            
            const company = prompt('Enter company name:');
            if (!company) return;
            
            const team = parseInt(prompt('Enter team (1 or 2):'));
            if (team !== 1 && team !== 2) return;
            
            const founder = {
                id: 'custom_' + Date.now(),
                name: name,
                company: company,
                image: 'default.png',
                team: team
            };
            
            foundersDatabase[team].push(founder);
            founderWealth[founder.id] = 0;
            
            database.ref('game/founders').set(foundersDatabase);
            database.ref('game/founderWealth').set(founderWealth);
            updateFounderDisplay();
            log(`Added ${name} to Team ${team}`, 'success');
        }

        // Valuation management
        function addValuation(company, amount) {
            currentCompanies[company].valuation += amount;
            database.ref(`game/companies/${company}/valuation`).set(currentCompanies[company].valuation);
            log(`Company ${company}: ${amount > 0 ? '+' : ''}${amount}`, 'success');
        }

        function setActiveCompany(company) {
            currentTeam = company;
            database.ref('game/currentTeam').set(company);
            log(`Set active company to ${company}`, 'success');
        }

        // Helper function to sanitize Firebase keys
        function sanitizeFirebaseKey(key) {
            return key.replace(/\./g, '_');
        }

        // Challenge and card management
        function approveSelection() {
            if (!pendingSelection) return;
            
            const { category, team, value } = pendingSelection;
            
            // Get challenges from database or use defaults
            const challenges = challengeDatabase[category]?.[value] || [
                { description: "Default challenge 1 for " + category, value: value },
                { description: "Default challenge 2 for " + category, value: value },
                { description: "Default challenge 3 for " + category, value: value },
                { description: "Default challenge 4 for " + category, value: value },
                { description: "Default challenge 5 for " + category, value: value }
            ];

            // Set active challenges with proper structure
            database.ref('game/activeChallenges').set({
                category: category,
                value: value,
                team: team,
                challenges: challenges.map(c => ({ 
                    description: c.description,
                    value: c.value,
                    completed: false, 
                    completedBy: null, 
                    completedByTeam: null 
                })),
                timestamp: Date.now()
            });

            // Mark cell as in progress on the board
            const cellKey = `${category}-${value}`;
            const sanitizedKey = sanitizeFirebaseKey(cellKey);
            database.ref(`game/board/${sanitizedKey}`).set({
                inProgress: true,
                team: team,
                originalKey: cellKey
            });

            // Clear pending
            database.ref('game/pendingSelection').remove();
            pendingSelection = null;
            
            log(`Approved: ${category} ${value} for Team ${team}`, 'success');
        }

        function rejectSelection() {
            if (!pendingSelection) return;
            database.ref('game/pendingSelection').remove();
            pendingSelection = null;
            log(`Rejected category selection`, 'error');
        }

        function rejectAndClearSelection() {
            if (!pendingSelection) {
                alert('No pending selection to clear!');
                return;
            }
            
            database.ref('game/pendingSelection').remove();
            pendingSelection = null;
            
            log('Rejected and cleared pending selection', 'error');
            
            const pendingDiv = document.getElementById('pendingSelection');
            pendingDiv.innerHTML = `
                <div class="current-card no-card">
                    <h3>‚è≥ Waiting for Team Selection</h3>
                    <p style="color: #666;">No category selected yet. Team ${currentTeam} should choose...</p>
                </div>
            `;
        }

        // Toggle scoring mode
        function toggleScoringMode() {
            personalScoringMode = !personalScoringMode;
            const button = document.getElementById('scoringModeBtn');
            const indicator = document.getElementById('scoringModeIndicator');
            
            if (personalScoringMode) {
                button.textContent = 'üí∞ MODE: PERSONAL ONLY';
                button.style.background = '#FFD700';
                button.style.color = '#000';
                indicator.textContent = '‚ö†Ô∏è PERSONAL MODE: Points go to founders only, NOT to teams!';
                indicator.style.display = 'block';
                log('Switched to PERSONAL scoring mode - founders keep money, teams get nothing!', 'error');
            } else {
                button.textContent = 'üè¢ MODE: TEAM + PERSONAL';
                button.style.background = 'var(--cyan)';
                button.style.color = '#000';
                indicator.style.display = 'none';
                log('Switched to NORMAL scoring mode - both teams and founders get points', 'success');
            }
        }

        function completeChallenge(index) {
            if (!activeChallenges || !selectedFounder) {
                alert('Please select a founder first!');
                return;
            }
            
            const challenge = activeChallenges.challenges[index];
            if (challenge.completed) return;

            const founder = [...(foundersDatabase[1] || []), ...(foundersDatabase[2] || [])].find(f => f.id === selectedFounder);
            if (!founder) {
                alert('Selected founder not found!');
                return;
            }

            // Check scoring mode
            if (personalScoringMode) {
                // PERSONAL MODE: Only award to founder, NOT to company
                log(`üí∞ PERSONAL MODE: ${founder.name} keeps all ${challenge.value} for themselves!`, 'error');
            } else {
                // NORMAL MODE: Award to company too
                addValuation(founder.team, challenge.value);
            }
            
            // Always update founder's individual wealth
            founderWealth[founder.id] = (founderWealth[founder.id] || 0) + challenge.value;
            database.ref(`game/founderWealth/${founder.id}`).set(founderWealth[founder.id]);
            
            // Update the challenge
            const updatedChallenges = [...activeChallenges.challenges];
            updatedChallenges[index] = {
                ...challenge,
                completed: true,
                completedBy: founder.name,
                completedByTeam: founder.team,
                completedByFounderId: founder.id,
                personalMode: personalScoringMode // Track if this was personal mode
            };
            
            // Update Firebase
            database.ref('game/activeChallenges/challenges').set(updatedChallenges);

            if (personalScoringMode) {
                log(`${founder.name} completed challenge for PERSONAL gain: +${challenge.value} (Team gets $0)`, 'error');
            } else {
                log(`${founder.name} (Team ${founder.team}) completed challenge for +${challenge.value}`, 'success');
            }
            
            // Clear selection
            selectedFounder = null;
            document.querySelectorAll('.founder-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Update display
            updateFounderDisplay();
        }

        // Individual Wallet Functions
        function openIndividualWallet() {
            const modal = document.getElementById('individualWalletModal');
            modal.style.display = 'block';
            loadWalletFounderList();
        }

        function closeIndividualWallet() {
            const modal = document.getElementById('individualWalletModal');
            modal.style.display = 'none';
            selectedWalletFounder = null;
        }

        function loadWalletFounderList() {
            const listDiv = document.getElementById('walletFounderList');
            const allFounders = [...(foundersDatabase[1] || []), ...(foundersDatabase[2] || [])];
            
            // Sort by wealth descending
            allFounders.sort((a, b) => (founderWealth[b.id] || 0) - (founderWealth[a.id] || 0));
            
            listDiv.innerHTML = allFounders.map(founder => {
                const wealth = founderWealth[founder.id] || 0;
                const teamColor = founder.team === 1 ? 'var(--team1-color)' : 'var(--team2-color)';
                
                return `
                    <div onclick="selectWalletFounder('${founder.id}')" 
                         style="padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.05); 
                                border: 2px solid ${teamColor}; border-radius: 8px; cursor: pointer; 
                                transition: all 0.3s ease; display: flex; align-items: center; gap: 10px;"
                         onmouseover="this.style.transform='scale(1.02)'"
                         onmouseout="this.style.transform='scale(1)'">
                        <img src="assets/founders/${founder.image}" 
                             style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid ${teamColor};">
                        <div style="flex: 1;">
                            <div style="font-weight: bold;">${founder.name}</div>
                            <div style="font-size: 12px; color: #999;">${founder.handle || 'No handle'}</div>
                        </div>
                        <div style="color: var(--yellow); font-weight: bold;">${wealth.toLocaleString()}</div>
                    </div>
                `;
            }).join('');
        }

        function selectWalletFounder(founderId) {
            selectedWalletFounder = founderId;
            const founder = [...(foundersDatabase[1] || []), ...(foundersDatabase[2] || [])].find(f => f.id === founderId);
            
            if (!founder) return;
            
            // Update display
            document.getElementById('walletDetails').style.display = 'block';
            document.getElementById('walletFounderImage').src = `assets/founders/${founder.image}`;
            document.getElementById('walletFounderName').textContent = founder.name;
            document.getElementById('walletFounderHandle').textContent = founder.handle || 'No handle';
            document.getElementById('walletFounderWealth').textContent = `${(founderWealth[founderId] || 0).toLocaleString()}`;
            
            // Load achievements
            loadWalletAchievements(founderId);
        }

        function loadWalletAchievements(founderId) {
            const achievementsDiv = document.getElementById('walletAchievements');
            const founder = [...(foundersDatabase[1] || []), ...(foundersDatabase[2] || [])].find(f => f.id === founderId);
            
            database.ref('game/board').once('value', (snapshot) => {
                const board = snapshot.val() || {};
                const achievements = [];
                
                Object.keys(board).forEach(cellKey => {
                    const cell = board[cellKey];
                    if (cell.challenges && Array.isArray(cell.challenges)) {
                        cell.challenges.forEach((challenge, idx) => {
                            if (challenge.completed && 
                                (challenge.completedByFounderId === founderId || 
                                 (challenge.completedBy === founder.name && !challenge.completedByFounderId))) {
                                
                                const category = cell.originalKey ? 
                                    cell.originalKey.split('-')[0] : 
                                    cellKey.replace(/_/g, '.').split('-')[0];
                                
                                achievements.push({
                                    category: category,
                                    description: challenge.description,
                                    value: challenge.value,
                                    cellKey: cellKey,
                                    challengeIndex: idx,
                                    personalMode: challenge.personalMode || false
                                });
                            }
                        });
                    }
                });
                
                if (achievements.length > 0) {
                    achievementsDiv.innerHTML = achievements.map((achievement, idx) => `
                        <div style="background: rgba(138,43,226,0.2); border-radius: 8px; padding: 12px; margin-bottom: 8px; 
                                   border: 1px solid rgba(138,43,226,0.4);">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="color: var(--cyan); font-size: 12px; text-transform: uppercase;">
                                        ${achievement.category.replace(/-/g, ' ')}
                                        ${achievement.personalMode ? '<span style="color: var(--yellow);"> (PERSONAL)</span>' : ''}
                                    </div>
                                    <div style="font-size: 14px; margin: 5px 0;">${achievement.description}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: var(--yellow); font-weight: bold; font-size: 18px;">
                                        ${achievement.value}
                                    </div>
                                    <button onclick="rewardAchievement('${achievement.cellKey}', ${achievement.challengeIndex}, ${achievement.value})" 
                                            style="font-size: 12px; padding: 5px 10px; margin-top: 5px;">
                                        +Award Again
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    achievementsDiv.innerHTML = '<div style="color: #666; text-align: center;">No completed challenges yet</div>';
                }
            });
        }

        function addCustomAmount() {
            const amount = parseInt(document.getElementById('customAmount').value);
            if (!amount || amount <= 0 || !selectedWalletFounder) return;
            
            addMoneyToFounder(selectedWalletFounder, amount, 'Custom bonus');
            document.getElementById('customAmount').value = '';
        }

        function addQuickAmount(amount) {
            if (!selectedWalletFounder) return;
            addMoneyToFounder(selectedWalletFounder, amount, `Quick add ${amount}`);
        }

        function rewardAchievement(cellKey, challengeIndex, value) {
            if (!selectedWalletFounder) return;
            
            database.ref(`game/board/${cellKey}/challenges/${challengeIndex}`).once('value', (snapshot) => {
                const challenge = snapshot.val();
                if (challenge) {
                    addMoneyToFounder(selectedWalletFounder, value, `Bonus for: ${challenge.description}`);
                }
            });
        }

        function addMoneyToFounder(founderId, amount, reason) {
            const currentWealth = founderWealth[founderId] || 0;
            const newWealth = currentWealth + amount;
            
            founderWealth[founderId] = newWealth;
            database.ref(`game/founderWealth/${founderId}`).set(newWealth);
            
            // Update display
            document.getElementById('walletFounderWealth').textContent = `${newWealth.toLocaleString()}`;
            
            // Log the transaction
            log(`üí∞ Added ${amount} to ${founderId} (${reason}). New total: ${newWealth}`, 'success');
            
            // Refresh the founder list
            loadWalletFounderList();
            
            // Update main display
            updateFounderDisplay();
        }

        // Undo last challenge completion
        function undoChallenge(index) {
            if (!activeChallenges) return;
            
            const challenge = activeChallenges.challenges[index];
            if (!challenge.completed) return;
            
            if (confirm(`Undo completion of this challenge by ${challenge.completedBy}?`)) {
                // Only subtract from company if it wasn't personal mode
                if (!challenge.personalMode) {
                    addValuation(challenge.completedByTeam, -challenge.value);
                }
                
                // Always subtract from founder wealth
                if (challenge.completedByFounderId) {
                    founderWealth[challenge.completedByFounderId] = Math.max(0, (founderWealth[challenge.completedByFounderId] || 0) - challenge.value);
                    database.ref(`game/founderWealth/${challenge.completedByFounderId}`).set(founderWealth[challenge.completedByFounderId]);
                }
                
                // Update the challenge
                const updatedChallenges = [...activeChallenges.challenges];
                updatedChallenges[index] = {
                    description: challenge.description,
                    value: challenge.value,
                    completed: false,
                    completedBy: null,
                    completedByTeam: null,
                    completedByFounderId: null,
                    personalMode: false
                };
                
                // Update Firebase
                database.ref('game/activeChallenges/challenges').set(updatedChallenges);
                
                log(`Undid challenge completion for ${challenge.completedBy}${challenge.personalMode ? ' (was personal mode)' : ''}`, 'error');
                
                // Update display
                updateFounderDisplay();
            }
        }

        function updateChallengeProgress() {
            if (!activeChallenges) return;
            
            const total = activeChallenges.challenges.length;
            const completed = activeChallenges.challenges.filter(c => c.completed).length;
            const remaining = total - completed;
            const percentage = (completed / total) * 100;
            
            document.getElementById('progressText').textContent = `${completed}/${total} Completed`;
            document.getElementById('progressFill').style.width = `${percentage}%`;
            document.getElementById('remainingChallenges').textContent = `${remaining} Left`;
        }

        function closeCurrentCard() {
            if (!activeChallenges) return;
            
            const team1Wins = activeChallenges.challenges.filter(c => c.completedByTeam === 1).length;
            const team2Wins = activeChallenges.challenges.filter(c => c.completedByTeam === 2).length;
            
            let cardWinner;
            if (team1Wins > team2Wins) {
                cardWinner = 1;
                log(`Card completed! Y2Ket Corp. won ${team1Wins}/${activeChallenges.challenges.length} challenges`, 'success');
            } else if (team2Wins > team1Wins) {
                cardWinner = 2;
                log(`Card completed! Series A(pocalypse) won ${team2Wins}/${activeChallenges.challenges.length} challenges`, 'success');
            } else {
                log(`Card completed! Tie: ${team1Wins}-${team2Wins}`, 'success');
                cardWinner = null;
            }
            
            // Update board state - sanitize the key
            const cellKey = `${activeChallenges.category}-${activeChallenges.value}`;
            const sanitizedKey = sanitizeFirebaseKey(cellKey);
            database.ref(`game/board/${sanitizedKey}`).set({
                completed: true,
                winnerTeam: cardWinner,
                challenges: activeChallenges.challenges,
                inProgress: false,
                originalKey: cellKey
            });
            
            // Clear active challenges
            database.ref('game/activeChallenges').remove();
            activeChallenges = null;
            
            // Set next team
            if (cardWinner) {
                setActiveCompany(cardWinner);
                log(`Team ${cardWinner} gets to choose next card!`, 'success');
            }
        }

        function nextTeamTurn() {
            const newTeam = currentTeam === 1 ? 2 : 1;
            setActiveCompany(newTeam);
        }

        function cancelCurrentRound() {
            if (!activeChallenges) {
                alert('No active round to cancel!');
                return;
            }
            
            const category = activeChallenges.category;
            const value = activeChallenges.value;
            
            if (confirm(`Cancel the current round?\n\n${category.replace(/-/g, ' ').toUpperCase()} - ${value}\n\nThis will NOT save any progress from this round.`)) {
                
                // Clear the active challenges
                database.ref('game/activeChallenges').remove();
                
                // Remove the "in progress" status from the board cell
                const cellKey = `${category}-${value}`;
                const sanitizedKey = sanitizeFirebaseKey(cellKey);
                
                // Check if any challenges were completed in this round
                let hadProgress = false;
                if (activeChallenges.challenges) {
                    hadProgress = activeChallenges.challenges.some(c => c.completed);
                }
                
                if (hadProgress) {
                    // If there was some progress, we need to reverse any points that were awarded
                    activeChallenges.challenges.forEach(challenge => {
                        if (challenge.completed && challenge.completedByFounderId) {
                            // Subtract points from founder
                            const currentWealth = founderWealth[challenge.completedByFounderId] || 0;
                            founderWealth[challenge.completedByFounderId] = Math.max(0, currentWealth - challenge.value);
                            database.ref(`game/founderWealth/${challenge.completedByFounderId}`).set(founderWealth[challenge.completedByFounderId]);
                            
                            // Subtract points from team only if not personal mode
                            if (!challenge.personalMode) {
                                const currentValuation = currentCompanies[challenge.completedByTeam].valuation || 0;
                                currentCompanies[challenge.completedByTeam].valuation = Math.max(0, currentValuation - challenge.value);
                                database.ref(`game/companies/${challenge.completedByTeam}/valuation`).set(currentCompanies[challenge.completedByTeam].valuation);
                            }
                            
                            log(`Reversed: -${challenge.value} from ${challenge.completedBy}`, 'error');
                        }
                    });
                }
                
                // Clear the board cell's in-progress status
                database.ref(`game/board/${sanitizedKey}`).remove();
                
                // Clear local state
                activeChallenges = null;
                
                // Update displays
                updateFounderDisplay();
                
                log(`Cancelled round: ${category} ${value}`, 'error');
                
                // Hide the active card display
                document.getElementById('activeCard').style.display = 'none';
                document.getElementById('pendingSelection').style.display = 'block';
            }
        }

        // Enhanced challenge editing functions
        function loadChallengesForEdit() {
            const categorySelect = document.getElementById('editCategorySelect');
            const editor = document.getElementById('challengeEditor');
            const inputs = document.getElementById('challengeInputs');
            
            const category = categorySelect.value;
            if (!category) {
                editor.style.display = 'none';
                return;
            }
            
            editor.style.display = 'block';
            
            let html = `<h4 style="color: var(--cyan); margin-bottom: 20px;">${category.replace(/-/g, ' ').toUpperCase()} - Edit Challenges</h4>`;
            
            const values = [400]; // Focus on $300 for now
            
            values.forEach(value => {
                html += `
                    <div class="value-editor-section" style="margin-bottom: 30px;">
                        <div class="value-editor-header" style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="color: var(--yellow); font-size: 1.3em;">üí∞ ${value} Challenges</h4>
                        </div>
                        <div class="value-challenges show">
                `;
                
                for (let i = 0; i < 5; i++) {
                    const challenge = challengeDatabase[category]?.[value]?.[i] || { description: '', value: value };
                    html += `
                        <div class="challenge-input-group">
                            <label class="challenge-input-label">Challenge ${i + 1}</label>
                            <textarea 
                                id="challenge_${value}_${i}" 
                                placeholder="Enter challenge description for ${value}..."
                                style="width: 100%; min-height: 60px; resize: vertical;"
                            >${challenge.description}</textarea>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            inputs.innerHTML = html;
        }

        function saveChallenges() {
            const categorySelect = document.getElementById('editCategorySelect');
            const category = categorySelect.value;
            
            if (!category) return;
            
            // Count how many challenges we're saving
            let challengeCount = 0
            const values = [400]; 
            
            values.forEach(value => {
                for (let i = 0; i < 5; i++) {
                    const textarea = document.getElementById(`challenge_${value}_${i}`);
                    if (textarea && textarea.value.trim()) {
                        challengeCount++;
                    }
                }
            });
            
            if (challengeCount === 0) {
                alert('No challenges to save! Please add at least one challenge.');
                return;
            }
            
            if (!challengeDatabase[category]) {
                challengeDatabase[category] = {};
            }
            
            // Save challenges
            values.forEach(value => {
                challengeDatabase[category][value] = [];
                
                for (let i = 0; i < 5; i++) {
                    const textarea = document.getElementById(`challenge_${value}_${i}`);
                    if (textarea) {
                        const description = textarea.value.trim();
                        if (description) {
                            challengeDatabase[category][value].push({
                                description: description,
                                value: value
                            });
                        }
                    }
                }
            });
            
            // Save to Firebase with confirmation
            database.ref('game/challengeDatabase').set(challengeDatabase)
                .then(() => {
                    log(`‚úÖ Saved ${challengeCount} challenges for ${category}`, 'success');
                    alert(`Successfully saved ${challengeCount} challenges!`);
                })
                .catch((error) => {
                    log(`‚ùå Failed to save challenges: ${error.message}`, 'error');
                    alert('Failed to save challenges. Please try again.');
                });
        }

        // Game control functions
        function clearStaleData() {
            database.ref('game/activeChallenges').remove();
            database.ref('game/pendingSelection').remove();
            log('Cleared stale game data', 'success');
        }

        function pauseGame() {
            database.ref('game/paused').set(true);
            log('Game paused', 'error');
        }

        function resumeGame() {
            database.ref('game/paused').set(false);
            log('Game resumed', 'success');
        }

        function openScoreEditor() {
            console.log('Opening score editor...');
            
            // Create a modal for editing scores
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 10000;
                overflow-y: auto;
                padding: 20px;
            `;
            
            const container = document.createElement('div');
            container.style.cssText = `
                max-width: 900px;
                margin: 0 auto;
                background: #1a1a1a;
                border-radius: 20px;
                padding: 30px;
                border: 3px solid var(--cyan);
            `;
            
            container.innerHTML = `
                <h2 style="color: var(--cyan); margin-bottom: 20px;">üìù SCORE EDITOR - Fix Incorrect Assignments</h2>
                <p style="color: #999; margin-bottom: 20px;">Click on any completed challenge to reassign it to a different founder.</p>
                <div id="scoreEditorContent">Loading challenges...</div>
                <button onclick="closeScoreEditor()" style="margin-top: 20px; background: var(--pink); color: white;">Close Editor</button>
            `;
            
            modal.appendChild(container);
            document.body.appendChild(modal);
            modal.id = 'scoreEditorModal';
            
            // Load all completed challenges
            loadCompletedChallenges();
        }

        function closeScoreEditor() {
            const modal = document.getElementById('scoreEditorModal');
            if (modal) {
                modal.remove();
            }
        }

        function loadCompletedChallenges() {
            database.ref('game/board').once('value', (snapshot) => {
                const board = snapshot.val() || {};
                const content = document.getElementById('scoreEditorContent');
                let html = '';
                
                Object.keys(board).forEach(cellKey => {
                    const cell = board[cellKey];
                    if (cell.challenges && cell.completed) {
                        const categoryName = (cell.originalKey || cellKey).replace(/_/g, '.').split('-')[0].replace(/-/g, ' ').toUpperCase();
                        
                        html += `<div style="margin-bottom: 30px; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px;">`;
                        html += `<h3 style="color: var(--yellow); margin-bottom: 15px;">${categoryName} - ${cell.challenges[0]?.value || 100}</h3>`;
                        
                        cell.challenges.forEach((challenge, idx) => {
                            if (challenge.completed) {
                                const teamColor = challenge.completedByTeam === 1 ? 'var(--team1-color)' : 'var(--team2-color)';
                                
                                html += `
                                    <div style="background: rgba(0,0,0,0.5); padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 2px solid ${teamColor};">
                                        <div style="display: flex; justify-content: space-between; align-items: start;">
                                            <div style="flex: 1;">
                                                <p style="color: #ccc; margin-bottom: 8px;">${challenge.description}</p>
                                                <p style="color: ${teamColor}; font-weight: bold;">
                                                    ‚úì Completed by: ${challenge.completedBy} (Team ${challenge.completedByTeam})
                                                    ${challenge.personalMode ? '<span style="color: var(--yellow);"> [PERSONAL MODE]</span>' : ''}
                                                </p>
                                            </div>
                                            <div style="display: flex; gap: 10px; align-items: center;">
                                                <span style="color: var(--yellow); font-weight: bold; font-size: 1.2em;">${challenge.value}</span>
                                                <button onclick="reassignChallenge('${cellKey}', ${idx})" 
                                                        style="background: var(--purple); padding: 8px 15px; font-size: 0.9em;">
                                                    Reassign
                                                </button>
                                                <button onclick="removeChallenge('${cellKey}', ${idx})" 
                                                        style="background: #ff3333; padding: 8px 15px; font-size: 0.9em;">
                                                    Remove
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                        
                        html += `</div>`;
                    }
                });
                
                content.innerHTML = html || '<p style="color: #666;">No completed challenges found.</p>';
            });
        }

        function reassignChallenge(cellKey, challengeIndex) {
            // Implementation remains the same as before
            // (Omitted for brevity - use the same implementation from the original)
        }

        function executeReassignment(cellKey, challengeIndex, oldChallenge, newFounder) {
            // Implementation remains the same as before
            // (Omitted for brevity - use the same implementation from the original)
        }

        function removeChallenge(cellKey, challengeIndex) {
            // Implementation remains the same as before
            // (Omitted for brevity - use the same implementation from the original)
        }

        function resetValuations() {
            if (confirm('Reset all company valuations to $0?')) {
                database.ref('game/companies').set({
                    1: { name: "Y2Ket Corp.", valuation: 0 },
                    2: { name: "Series A(pocalypse)", valuation: 0 }
                });
                
                // Also reset founder wealth
                Object.keys(founderWealth).forEach(founderId => {
                    founderWealth[founderId] = 0;
                });
                database.ref('game/founderWealth').set(founderWealth);
                
                updateFounderDisplay();
                log('Valuations and founder wealth reset', 'success');
            }
        }

        function resetAll() {
            if (confirm('Reset EVERYTHING? This cannot be undone!')) {
                database.ref('game').set({
                    currentTeam: 1,
                    companies: {
                        1: { name: "Y2Ket Corp.", valuation: 0 },
                        2: { name: "Series A(pocalypse)", valuation: 0 }
                    },
                    challengeDatabase: challengeDatabase,
                    board: {},
                    founderWealth: {}
                });
                
                // Reset local state
                founderWealth = {};
                foundersDatabase = { 1: [], 2: [] };
                updateFounderDisplay();
                
                log('Game completely reset', 'success');
            }
        }

        // Setup listeners
        function setupListeners() {
            // Connection monitoring
            database.ref('.info/connected').on('value', (snapshot) => {
                updateConnectionStatus(snapshot.val() === true);
            });

            // Initialize challenge database if empty
            database.ref('game/challengeDatabase').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    database.ref('game/challengeDatabase').set(challengeDatabase);
                    log('Initialized challenge database with defaults', 'success');
                }
            });

            // Load challenges from Firebase
            database.ref('game/challengeDatabase').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // Only update if we're not currently editing
                    const editCategory = document.getElementById('editCategorySelect').value;
                    if (!editCategory) {
                        challengeDatabase = data;
                        log('Challenge database loaded', 'success');
                    } else {
                        // Merge without overwriting current edits
                        Object.keys(data).forEach(category => {
                            if (category !== editCategory) {
                                challengeDatabase[category] = data[category];
                            }
                        });
                    }
                }
            });

            // Load founders from Firebase
            database.ref('game/founders').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    foundersDatabase = data;
                    updateFounderDisplay();
                }
            });

            // Load founder wealth
            database.ref('game/founderWealth').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    founderWealth = data;
                    updateFounderDisplay();
                }
            });

            // Company valuations
            database.ref('game/companies').on('value', (snapshot) => {
                const companies = snapshot.val() || {};
                currentCompanies = companies;
                document.getElementById('valuation1').textContent = `${(companies[1]?.valuation || 0).toLocaleString()}`;
                document.getElementById('valuation2').textContent = `${(companies[2]?.valuation || 0).toLocaleString()}`;
                updateGameStatus('Companies updated');
            });

            // Current team
            database.ref('game/currentTeam').on('value', (snapshot) => {
                currentTeam = snapshot.val() || 1;
                updateGameStatus(`Active: Team ${currentTeam}`);
            });

            // Pending selection
            database.ref('game/pendingSelection').on('value', (snapshot) => {
                pendingSelection = snapshot.val();
                const pendingDiv = document.getElementById('pendingSelection');
                const activeDiv = document.getElementById('activeCard');
                
                if (pendingSelection && !activeChallenges) {
                    pendingDiv.innerHTML = `
                        <div class="pending-selection">
                            <h3>üéØ Team Selection Pending</h3>
                            <p>Team ${pendingSelection.team} wants:</p>
                            <p style="font-size: 1.5em; color: var(--yellow); margin: 10px 0;">
                                ${pendingSelection.category.replace(/-/g, ' ').toUpperCase()} - ${pendingSelection.value}
                            </p>
                            <div class="button-group">
                                <button onclick="approveSelection()" class="success">‚úì Approve & Start Round</button>
                                <button onclick="rejectSelection()" class="danger">‚úó Reject</button>
                                <button onclick="rejectAndClearSelection()" class="danger">üóëÔ∏è Reject & Clear</button> 
                            </div>
                        </div>
                    `;
                    activeDiv.style.display = 'none';
                    updateGameStatus('Pending selection...');
                } else if (!activeChallenges) {
                    pendingDiv.innerHTML = `
                        <div class="current-card no-card">
                            <h3>‚è≥ Waiting for Team Selection</h3>
                            <p style="color: #666;">No category selected yet. Team ${currentTeam} should choose...</p>
                        </div>
                    `;
                    activeDiv.style.display = 'none';
                }
            });

            // Active challenges
            database.ref('game/activeChallenges').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.challenges && data.challenges.length > 0) {
                    activeChallenges = data;
                    const pendingDiv = document.getElementById('pendingSelection');
                    const activeDiv = document.getElementById('activeCard');
                    
                    pendingDiv.style.display = 'none';
                    activeDiv.style.display = 'block';
                    
                    document.getElementById('currentCardTitle').textContent = 
                        `üéØ ${data.category.replace(/-/g, ' ').toUpperCase()} - ${data.value}`;
                    
                    const challengeList = document.getElementById('challengeList');
                    challengeList.innerHTML = data.challenges.map((challenge, idx) => `
                        <div class="challenge-item ${challenge.completed ? 'completed' : ''}">
                            <div class="challenge-header">
                                <div class="challenge-value">${challenge.value}</div>
                                <div class="challenge-status ${challenge.completed ? 'status-completed' : 'status-available'}">
                                    ${challenge.completed ? 'COMPLETED' : 'AVAILABLE'}
                                </div>
                            </div>
                            <p style="margin-bottom: 10px;">${challenge.description}</p>
                            ${challenge.completed ? 
                                `<p style="color: #00ff00; font-weight: bold;">
                                    ‚úì Completed by: ${challenge.completedBy} (Team ${challenge.completedByTeam})
                                    ${challenge.personalMode ? '<span style="color: var(--yellow);"> üí∞ PERSONAL MODE</span>' : ''}
                                </p>
                                <button onclick="undoChallenge(${idx})" class="undo-button">‚Ü∫ Undo</button>` :
                                `<div class="challenge-controls">
                                    <span style="color: var(--yellow);">Select founder above, then:</span>
                                    <button onclick="completeChallenge(${idx})" class="success">
                                        ‚úì Mark Complete
                                    </button>
                                </div>`
                            }
                        </div>
                    `).join('');
                    
                    updateChallengeProgress();
                    updateGameStatus(`Active: ${data.category} ${data.value}`);
                } else {
                    activeChallenges = null;
                    const activeDiv = document.getElementById('activeCard');
                    const pendingDiv = document.getElementById('pendingSelection');
                    activeDiv.style.display = 'none';
                    
                    // Only show pending div if there's no pending selection already shown
                    if (!pendingSelection) {
                        pendingDiv.style.display = 'block';
                    }
                }
            });
        }

        // Initialize
        window.onload = () => {
            loadRandomBackground();
            
            // Initialize game state if needed
            database.ref('game').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    database.ref('game').set({
                        currentTeam: 1,
                        companies: {
                            1: { name: "Y2Ket Corp.", valuation: 0 },
                            2: { name: "Series A(pocalypse)", valuation: 0 }
                        },
                        challengeDatabase: challengeDatabase,
                        board: {},
                        founderWealth: {}
                    });
                    log('Initialized new game', 'success');
                }
            });
            
            setupListeners();
            updateFounderDisplay();
            log('Moderator panel initialized', 'success');
            updateGameStatus('Ready for game');
        };

        // Make these functions globally accessible
        window.reassignChallenge = reassignChallenge;
        window.executeReassignment = executeReassignment;
        window.removeChallenge = removeChallenge;
        window.closeScoreEditor = closeScoreEditor;
        function openFirebaseDiagnostic() {
    document.getElementById('firebaseDiagnosticModal').style.display = 'block';
}

function closeFirebaseDiagnostic() {
    document.getElementById('firebaseDiagnosticModal').style.display = 'none';
}

function viewDoomScrollData() {
    const doomScrollKey = 'doom-scroll-nation-100'.replace(/\./g, '_');
    
    database.ref(`game/board/${doomScrollKey}`).once('value', (snapshot) => {
        const data = snapshot.val();
        const viewer = document.getElementById('rawDataViewer');
        
        if (data) {
            viewer.textContent = JSON.stringify(data, null, 2);
            
            // Also show a summary
            let summary = `\nSUMMARY:\n`;
            summary += `- In Progress: ${data.inProgress || false}\n`;
            summary += `- Completed: ${data.completed || false}\n`;
            summary += `- Winner Team: ${data.winnerTeam || 'None'}\n`;
            
            if (data.challenges) {
                const completedCount = data.challenges.filter(c => c.completed).length;
                summary += `- Challenges: ${completedCount}/${data.challenges.length} completed\n`;
                
                // Count by team
                let team1 = 0, team2 = 0;
                data.challenges.forEach(c => {
                    if (c.completed) {
                        if (c.completedByTeam === 1) team1++;
                        else if (c.completedByTeam === 2) team2++;
                    }
                });
                summary += `- Team 1 wins: ${team1}\n`;
                summary += `- Team 2 wins: ${team2}\n`;
            }
            
            viewer.textContent = summary + '\n-------------------\n' + viewer.textContent;
        } else {
            viewer.textContent = 'No data found for doom-scroll-nation-100';
        }
    });
}

function forceClearDoomScroll() {
    if (confirm('This will completely clear all data for Doom Scroll Nation $100. Are you sure?')) {
        const doomScrollKey = 'doom-scroll-nation-100'.replace(/\./g, '_');
        
        database.ref(`game/board/${doomScrollKey}`).remove()
            .then(() => {
                log('Cleared Doom Scroll Nation $100 data', 'success');
                alert('Cleared! The cell should now appear as available.');
                viewDoomScrollData(); // Refresh the view
            })
            .catch(error => {
                log('Failed to clear: ' + error.message, 'error');
            });
    }
}

function forceCompleteDoomScroll() {
    const doomScrollKey = 'doom-scroll-nation-100'.replace(/\./g, '_');
    
    // First, get the current data
    database.ref(`game/board/${doomScrollKey}`).once('value', (snapshot) => {
        const currentData = snapshot.val() || {};
        
        // If there are challenges, count wins
        let winnerTeam = null;
        if (currentData.challenges) {
            let team1Wins = 0, team2Wins = 0;
            currentData.challenges.forEach(c => {
                if (c.completed && c.completedByTeam === 1) team1Wins++;
                else if (c.completed && c.completedByTeam === 2) team2Wins++;
            });
            
            if (team1Wins > team2Wins) winnerTeam = 1;
            else if (team2Wins > team1Wins) winnerTeam = 2;
        }
        
        // Force update to completed state
        database.ref(`game/board/${doomScrollKey}`).update({
            completed: true,
            inProgress: false,
            winnerTeam: winnerTeam,
            originalKey: 'doom-scroll-nation-100'
        }).then(() => {
            log('Forced Doom Scroll Nation $100 to completed state', 'success');
            alert('Marked as completed! The cell should now show as finished.');
            viewDoomScrollData(); // Refresh the view
        });
    });
}

function loadBoardDiagnostic() {
    database.ref('game/board').once('value', (snapshot) => {
        const boardData = snapshot.val() || {};
        const content = document.getElementById('boardDiagnosticContent');
        
        let html = '<table style="width: 100%; color: #fff; font-size: 12px;">';
        html += '<tr style="border-bottom: 1px solid #444;"><th>Cell</th><th>Status</th><th>Winner</th><th>Challenges</th><th>Actions</th></tr>';
        
        Object.keys(boardData).forEach(cellKey => {
            const cell = boardData[cellKey];
            const originalKey = cell.originalKey || cellKey.replace(/_/g, '.');
            
            let status = 'Unknown';
            if (cell.completed) status = '‚úì Completed';
            else if (cell.inProgress) status = '‚ö° In Progress';
            else status = '‚≠ï Available';
            
            let challengeInfo = 'No challenges';
            if (cell.challenges) {
                const completed = cell.challenges.filter(c => c.completed).length;
                challengeInfo = `${completed}/${cell.challenges.length}`;
            }
            
            html += `<tr style="border-bottom: 1px solid #222;">`;
            html += `<td style="padding: 8px;">${originalKey}</td>`;
            html += `<td style="color: ${cell.completed ? '#0f0' : (cell.inProgress ? '#ff0' : '#666')}">${status}</td>`;
            html += `<td>Team ${cell.winnerTeam || '-'}</td>`;
            html += `<td>${challengeInfo}</td>`;
            html += `<td>`;
            html += `<button onclick="viewCellData('${cellKey}')" style="font-size: 10px; padding: 2px 8px; margin-right: 5px;">View</button>`;
            html += `<button onclick="clearCell('${cellKey}')" style="font-size: 10px; padding: 2px 8px; background: #f33;">Clear</button>`;
            html += `</td>`;
            html += `</tr>`;
        });
        
        html += '</table>';
        content.innerHTML = html;
    });
}

function viewCellData(cellKey) {
    database.ref(`game/board/${cellKey}`).once('value', (snapshot) => {
        const data = snapshot.val();
        const viewer = document.getElementById('rawDataViewer');
        viewer.textContent = `Data for ${cellKey}:\n\n${JSON.stringify(data, null, 2)}`;
    });
}

function clearCell(cellKey) {
    const originalKey = cellKey.replace(/_/g, '.');
    if (confirm(`Clear all data for ${originalKey}?`)) {
        database.ref(`game/board/${cellKey}`).remove()
            .then(() => {
                log(`Cleared ${originalKey}`, 'success');
                loadBoardDiagnostic(); // Refresh the list
            });
    }
}

// Also check for any active challenges that might be stuck
function checkActiveChallenge() {
    database.ref('game/activeChallenges').once('value', (snapshot) => {
        const data = snapshot.val();
        if (data && data.category === 'doom-scroll-nation' && data.value === 100) {
            console.log('Found active Doom Scroll Nation challenge:', data);
            if (confirm('Doom Scroll Nation $100 is marked as active. Clear this active state?')) {
                database.ref('game/activeChallenges').remove();
            }
        }
    });
}
function openChallengeWinnerEditor() {
    document.getElementById('challengeWinnerModal').style.display = 'block';
    populateCompletedCells();
}

function closeChallengeWinnerEditor() {
    document.getElementById('challengeWinnerModal').style.display = 'none';
}

function populateCompletedCells() {
    database.ref('game/board').once('value', (snapshot) => {
        const board = snapshot.val() || {};
        const select = document.getElementById('winnerEditorSelect');
        
        let options = '<option value="">Choose a completed cell...</option>';
        
        // Create sorted array of cells
        const cells = [];
        Object.keys(board).forEach(cellKey => {
            const cell = board[cellKey];
            if (cell.completed || cell.inProgress) {
                // Convert the key back to readable format
                const originalKey = cell.originalKey || cellKey.replace(/_/g, '.').replace(/_/g, '-');
                
                // Parse the category and value
                let category, value;
                const parts = originalKey.split('-');
                if (parts.length > 2) {
                    // Handle multi-word categories like doom-scroll-nation
                    value = parts[parts.length - 1];
                    category = parts.slice(0, -1).join('-');
                } else {
                    [category, value] = parts;
                }
                
                cells.push({
                    cellKey: cellKey,
                    category: category,
                    value: parseInt(value) || 0,
                    displayName: `${category.replace(/-/g, ' ').toUpperCase()} - ${value}`
                });
            }
        });
        
        // Sort by category then by value
        cells.sort((a, b) => {
            if (a.category !== b.category) {
                return a.category.localeCompare(b.category);
            }
            return a.value - b.value;
        });
        
        // Build options
        cells.forEach(cell => {
            options += `<option value="${cell.cellKey}">${cell.displayName}</option>`;
        });
        
        select.innerHTML = options;
    });
}

let currentEditingCell = null;
let currentChallenges = [];

function loadChallengeWinners() {
    const cellKey = document.getElementById('winnerEditorSelect').value;
    if (!cellKey) {
        document.getElementById('challengeWinnerContent').style.display = 'none';
        return;
    }
    
    currentEditingCell = cellKey;
    document.getElementById('challengeWinnerContent').style.display = 'block';
    
    database.ref(`game/board/${cellKey}`).once('value', (snapshot) => {
        const cellData = snapshot.val();
        const originalKey = cellData.originalKey || cellKey.replace(/_/g, '-');
        
        // Parse the category and value properly
        let category, value;
        const parts = originalKey.split('-');
        if (parts.length > 2) {
            // Handle multi-word categories
            value = parts[parts.length - 1];
            category = parts.slice(0, -1).join('-');
        } else {
            [category, value] = parts;
        }
        
        document.getElementById('selectedCellTitle').textContent = 
            `${category.replace(/-/g, ' ').toUpperCase()} - ${value}`;
        
        // Load challenges from the challenge database or use existing ones
        if (cellData.challenges && cellData.challenges.length > 0) {
            currentChallenges = cellData.challenges;
        } else {
            // Load from challenge database
            database.ref(`game/challengeDatabase/${category}/${value}`).once('value', (snapshot) => {
                const challenges = snapshot.val() || [];
                currentChallenges = challenges.map(c => ({
                    ...c,
                    completed: false,
                    completedBy: null,
                    completedByTeam: null
                }));
                renderChallengesList();
            });
            return;
        }
        
        renderChallengesList();
    });
}

function renderChallengesList() {
    const container = document.getElementById('challengesList');
    
    let html = '<div style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px;">';
    
    currentChallenges.forEach((challenge, idx) => {
        const isCompleted = challenge.completed || challenge.completedBy;
        const bgColor = isCompleted ? 'rgba(0,255,0,0.1)' : 'rgba(255,255,255,0.05)';
        const borderColor = challenge.completedByTeam === 1 ? 'var(--team1-color)' : 
                          challenge.completedByTeam === 2 ? 'var(--team2-color)' : '#666';
        
        html += `
            <div style="background: ${bgColor}; border: 2px solid ${borderColor}; 
                        border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h4 style="color: var(--cyan); margin-bottom: 8px;">Challenge ${idx + 1} - $${challenge.value || 100}</h4>
                        <p style="color: #ccc; margin-bottom: 10px;">${challenge.description || 'No description'}</p>
                        ${isCompleted ? 
                            `<p style="color: #0f0;">‚úì Won by: ${challenge.completedBy || 'Unknown'} (Team ${challenge.completedByTeam || '?'})</p>` :
                            `<p style="color: #999;">Not completed</p>`
                        }
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <select id="winner_select_${idx}" style="width: 200px;">
                            <option value="">Select winner...</option>
                            <optgroup label="Team 1 - Y2KET">
                                ${renderFounderOptions(1, challenge.completedBy)}
                            </optgroup>
                            <optgroup label="Team 2 - Series A">
                                ${renderFounderOptions(2, challenge.completedBy)}
                            </optgroup>
                        </select>
                        <button onclick="clearChallengeWinner(${idx})" style="background: #ff3333; font-size: 12px;">
                            Clear Winner
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function renderFounderOptions(team, selectedFounder) {
    const founders = foundersDatabase[team] || [];
    return founders.map(founder => 
        `<option value="${founder.id}" ${founder.name === selectedFounder ? 'selected' : ''}>
            ${founder.name}
        </option>`
    ).join('');
}

function clearChallengeWinner(idx) {
    currentChallenges[idx].completed = false;
    currentChallenges[idx].completedBy = null;
    currentChallenges[idx].completedByTeam = null;
    currentChallenges[idx].completedByFounderId = null;
    renderChallengesList();
}

function saveChallengeWinners() {
    // Update challenges based on selections
    currentChallenges.forEach((challenge, idx) => {
        const select = document.getElementById(`winner_select_${idx}`);
        const founderId = select.value;
        
        if (founderId) {
            const founder = [...(foundersDatabase[1] || []), ...(foundersDatabase[2] || [])]
                .find(f => f.id === founderId);
            
            if (founder) {
                challenge.completed = true;
                challenge.completedBy = founder.name;
                challenge.completedByTeam = founder.team;
                challenge.completedByFounderId = founder.id;
            }
        }
    });
    
    // Count wins per team
    let team1Wins = 0;
    let team2Wins = 0;
    currentChallenges.forEach(c => {
        if (c.completed) {
            if (c.completedByTeam === 1) team1Wins++;
            else if (c.completedByTeam === 2) team2Wins++;
        }
    });
    
    const winnerTeam = team1Wins > team2Wins ? 1 : (team2Wins > team1Wins ? 2 : null);
    
    // Update Firebase
    database.ref(`game/board/${currentEditingCell}`).update({
        challenges: currentChallenges,
        completed: true,
        inProgress: false,
        winnerTeam: winnerTeam
    }).then(() => {
        log(`Updated winners for ${currentEditingCell}`, 'success');
        alert(`Saved! Team 1: ${team1Wins} wins, Team 2: ${team2Wins} wins`);
        
        // Update founder wealth if needed
        updateFounderWealthFromChallenges();
    });
}

function updateFounderWealthFromChallenges() {
    // This recalculates founder wealth based on all completed challenges
    database.ref('game/board').once('value', (snapshot) => {
        const board = snapshot.val() || {};
        const newWealth = {};
        
        // Initialize all founders to 0
        [...(foundersDatabase[1] || []), ...(foundersDatabase[2] || [])]
            .forEach(founder => {
                newWealth[founder.id] = 0;
            });
        
        // Add up all completed challenges
        Object.values(board).forEach(cell => {
            if (cell.challenges) {
                cell.challenges.forEach(challenge => {
                    if (challenge.completed && challenge.completedByFounderId) {
                        newWealth[challenge.completedByFounderId] = 
                            (newWealth[challenge.completedByFounderId] || 0) + (challenge.value || 100);
                    }
                });
            }
        });
        
        // Update Firebase
        database.ref('game/founderWealth').set(newWealth)
            .then(() => {
                founderWealth = newWealth;
                updateFounderDisplay();
                log('Recalculated all founder wealth', 'success');
            });
    });
}

function autoDistributeWins() {
    if (!confirm('This will randomly distribute wins between the teams. Continue?')) return;
    
    // Get all founders
    const team1Founders = foundersDatabase[1] || [];
    const team2Founders = foundersDatabase[2] || [];
    
    currentChallenges.forEach((challenge, idx) => {
        // Randomly pick a team (slightly favor the losing team)
        const team = Math.random() < 0.5 ? 1 : 2;
        const founders = team === 1 ? team1Founders : team2Founders;
        
        if (founders.length > 0) {
            const randomFounder = founders[Math.floor(Math.random() * founders.length)];
            challenge.completed = true;
            challenge.completedBy = randomFounder.name;
            challenge.completedByTeam = team;
            challenge.completedByFounderId = randomFounder.id;
        }
    });
    
    renderChallengesList();
    alert('Randomly distributed wins! Review and click Save to confirm.');
}

// Quick function to recalculate all wealth
function recalculateAllWealth() {
    if (confirm('This will recalculate all founder wealth based on completed challenges. Continue?')) {
        updateFounderWealthFromChallenges();
    }
}
// Run this check when opening diagnostic
setTimeout(checkActiveChallenge, 500);
let walletRecoveryLog = [];

function openWalletRecovery() {
    document.getElementById('walletRecoveryModal').style.display = 'block';
    loadCurrentWalletStatus();
    populateRecoveryFounderSelect();
    addRecoveryLog('Wallet recovery tool opened');
}

function closeWalletRecovery() {
    document.getElementById('walletRecoveryModal').style.display = 'none';
}

function loadCurrentWalletStatus() {
    database.ref('game/founderWealth').once('value', (snapshot) => {
        const wealth = snapshot.val() || {};
        const statusDiv = document.getElementById('currentWalletStatus');
        
        const allFounders = [...(foundersDatabase[1] || []), ...(foundersDatabase[2] || [])];
        
        // Group by team and sort by wealth
        const team1 = allFounders.filter(f => f.team === 1).map(f => ({
            ...f,
            wealth: wealth[f.id] || 0
        })).sort((a, b) => b.wealth - a.wealth);
        
        const team2 = allFounders.filter(f => f.team === 2).map(f => ({
            ...f,
            wealth: wealth[f.id] || 0
        })).sort((a, b) => b.wealth - a.wealth);
        
        let html = '';
        
        // Team 1
        html += '<div style="margin-bottom: 20px;">';
        html += '<h4 style="color: var(--team1-color);">Team 1 - Y2KET CORP.</h4>';
        const team1Total = team1.reduce((sum, f) => sum + f.wealth, 0);
        html += `<p style="color: var(--yellow); margin-bottom: 10px;">Total: $${team1Total.toLocaleString()}</p>`;
        team1.forEach(founder => {
            const color = founder.wealth > 0 ? '#0f0' : '#999';
            html += `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #333;">
                <span>${founder.name}</span>
                <span style="color: ${color};">$${founder.wealth.toLocaleString()}</span>
            </div>`;
        });
        html += '</div>';
        
        // Team 2
        html += '<div>';
        html += '<h4 style="color: var(--team2-color);">Team 2 - SERIES A(POCALYPSE)</h4>';
        const team2Total = team2.reduce((sum, f) => sum + f.wealth, 0);
        html += `<p style="color: var(--yellow); margin-bottom: 10px;">Total: $${team2Total.toLocaleString()}</p>`;
        team2.forEach(founder => {
            const color = founder.wealth > 0 ? '#0f0' : '#999';
            html += `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #333;">
                <span>${founder.name}</span>
                <span style="color: ${color};">$${founder.wealth.toLocaleString()}</span>
            </div>`;
        });
        html += '</div>';
        
        statusDiv.innerHTML = html;
        
        addRecoveryLog(`Loaded current status - Team 1: $${team1Total}, Team 2: $${team2Total}`);
    });
}

function populateRecoveryFounderSelect() {
    const select = document.getElementById('recoveryFounderSelect');
    const allFounders = [...(foundersDatabase[1] || []), ...(foundersDatabase[2] || [])];
    
    let options = '<option value="">Select founder...</option>';
    options += '<optgroup label="Team 1 - Y2KET">';
    allFounders.filter(f => f.team === 1).forEach(founder => {
        options += `<option value="${founder.id}">${founder.name}</option>`;
    });
    options += '</optgroup>';
    
    options += '<optgroup label="Team 2 - Series A">';
    allFounders.filter(f => f.team === 2).forEach(founder => {
        options += `<option value="${founder.id}">${founder.name}</option>`;
    });
    options += '</optgroup>';
    
    select.innerHTML = options;
}

function addRecoveryLog(message) {
    const time = new Date().toLocaleTimeString();
    walletRecoveryLog.push(`[${time}] ${message}`);
    
    const logDiv = document.getElementById('walletAuditLog');
    logDiv.innerHTML = walletRecoveryLog.join('<br>');
    logDiv.scrollTop = logDiv.scrollHeight;
}

function exportWalletData() {
    database.ref('game/founderWealth').once('value', (snapshot) => {
        const wealth = snapshot.val() || {};
        const allFounders = [...(foundersDatabase[1] || []), ...(foundersDatabase[2] || [])];
        
        let exportText = 'WALLET DATA EXPORT - ' + new Date().toLocaleString() + '\n\n';
        exportText += 'Format: founderId:amount\n\n';
        
        allFounders.forEach(founder => {
            const amount = wealth[founder.id] || 0;
            exportText += `${founder.id}:${amount} # ${founder.name}\n`;
        });
        
        // Create a download
        const blob = new Blob([exportText], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'wallet_backup_' + Date.now() + '.txt';
        a.click();
        
        addRecoveryLog('Exported wallet data');
    });
}

function bulkUpdateWallets() {
    const bulkData = document.getElementById('bulkWalletData').value.trim();
    if (!bulkData) {
        alert('Please paste wallet data in the format: founderId:amount');
        return;
    }
    
    const updates = {};
    const lines = bulkData.split('\n');
    let updateCount = 0;
    
    lines.forEach(line => {
        const cleanLine = line.split('#')[0].trim(); // Remove comments
        if (cleanLine) {
            const [founderId, amount] = cleanLine.split(':');
            if (founderId && amount) {
                updates[founderId.trim()] = parseInt(amount) || 0;
                updateCount++;
            }
        }
    });
    
    if (updateCount === 0) {
        alert('No valid wallet data found');
        return;
    }
    
    if (confirm(`Update ${updateCount} wallets?`)) {
        database.ref('game/founderWealth').update(updates)
            .then(() => {
                founderWealth = { ...founderWealth, ...updates };
                updateFounderDisplay();
                loadCurrentWalletStatus();
                addRecoveryLog(`Bulk updated ${updateCount} wallets`);
                document.getElementById('bulkWalletData').value = '';
                alert(`Successfully updated ${updateCount} wallets!`);
            });
    }
}

function applyManualAdjustment(multiplier) {
    const founderId = document.getElementById('recoveryFounderSelect').value;
    const amount = parseInt(document.getElementById('recoveryAmount').value);
    const reason = document.getElementById('recoveryReason').value || 'Manual adjustment';
    
    if (!founderId || !amount) {
        alert('Please select a founder and enter an amount');
        return;
    }
    
    const founder = [...(foundersDatabase[1] || []), ...(foundersDatabase[2] || [])].find(f => f.id === founderId);
    if (!founder) return;
    
    const currentWealth = founderWealth[founderId] || 0;
    const adjustment = amount * multiplier;
    const newWealth = Math.max(0, currentWealth + adjustment);
    
    database.ref(`game/founderWealth/${founderId}`).set(newWealth)
        .then(() => {
            founderWealth[founderId] = newWealth;
            updateFounderDisplay();
            loadCurrentWalletStatus();
            
            const action = multiplier > 0 ? 'Added' : 'Subtracted';
            addRecoveryLog(`${action} $${Math.abs(adjustment)} ${multiplier > 0 ? 'to' : 'from'} ${founder.name}: ${reason}`);
            
            // Clear form
            document.getElementById('recoveryAmount').value = '';
            document.getElementById('recoveryReason').value = '';
        });
}

function setExactAmount() {
    const founderId = document.getElementById('recoveryFounderSelect').value;
    const amount = parseInt(document.getElementById('recoveryAmount').value);
    const reason = document.getElementById('recoveryReason').value || 'Set exact amount';
    
    if (!founderId || amount === undefined) {
        alert('Please select a founder and enter an amount');
        return;
    }
    
    const founder = [...(foundersDatabase[1] || []), ...(foundersDatabase[2] || [])].find(f => f.id === founderId);
    if (!founder) return;
    
    database.ref(`game/founderWealth/${founderId}`).set(amount)
        .then(() => {
            founderWealth[founderId] = amount;
            updateFounderDisplay();
            loadCurrentWalletStatus();
            
            addRecoveryLog(`Set ${founder.name} to exactly $${amount}: ${reason}`);
            
            // Clear form
            document.getElementById('recoveryAmount').value = '';
            document.getElementById('recoveryReason').value = '';
        });
}

function calculateFromChallenges() {
    if (!confirm('This will recalculate ALL wallets based on completed challenges. Current wallet values will be REPLACED. Continue?')) {
        return;
    }
    
    addRecoveryLog('Starting recalculation from challenges...');
    
    database.ref('game/board').once('value', (snapshot) => {
        const board = snapshot.val() || {};
        const newWealth = {};
        
        // Initialize all founders to 0
        [...(foundersDatabase[1] || []), ...(foundersDatabase[2] || [])].forEach(founder => {
            newWealth[founder.id] = 0;
        });
        
        let totalChallenges = 0;
        let totalValue = 0;
        
        // Add up all completed challenges
        Object.values(board).forEach(cell => {
            if (cell.challenges && Array.isArray(cell.challenges)) {
                cell.challenges.forEach(challenge => {
                    if (challenge.completed && challenge.completedByFounderId) {
                        const value = challenge.value || 100;
                        newWealth[challenge.completedByFounderId] = 
                            (newWealth[challenge.completedByFounderId] || 0) + value;
                        totalChallenges++;
                        totalValue += value;
                    }
                });
            }
        });
        
        addRecoveryLog(`Found ${totalChallenges} completed challenges worth $${totalValue}`);
        
        // Show preview
        let preview = 'PREVIEW OF CHANGES:\n\n';
        Object.keys(newWealth).forEach(founderId => {
            const oldWealth = founderWealth[founderId] || 0;
            const newAmount = newWealth[founderId];
            if (oldWealth !== newAmount) {
                const founder = [...(foundersDatabase[1] || []), ...(foundersDatabase[2] || [])].find(f => f.id === founderId);
                const diff = newAmount - oldWealth;
                preview += `${founder?.name || founderId}: $${oldWealth} ‚Üí $${newAmount} (${diff > 0 ? '+' : ''}${diff})\n`;
            }
        });
        
        if (confirm(preview + '\nApply these changes?')) {
            database.ref('game/founderWealth').set(newWealth)
                .then(() => {
                    founderWealth = newWealth;
                    updateFounderDisplay();
                    loadCurrentWalletStatus();
                    addRecoveryLog(`Recalculation complete - ${totalChallenges} challenges processed`);
                    alert('Wallet recalculation complete!');
                });
        }
    });
}

    </script>
    <div id="firebaseDiagnosticModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; overflow-y: auto; padding: 20px;">
        <div style="max-width: 1200px; margin: 0 auto; background: #1a1a1a; border-radius: 20px; padding: 30px; border: 3px solid var(--cyan);">
            <h2 style="color: var(--cyan); margin-bottom: 20px;">üîç FIREBASE DIAGNOSTIC TOOL</h2>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: var(--yellow);">Quick Fix: Doom Scroll Nation $100</h3>
                <button onclick="forceClearDoomScroll()" class="danger" style="margin-right: 10px;">üóëÔ∏è Clear Cell Data</button>
                <button onclick="forceCompleteDoomScroll()" class="success" style="margin-right: 10px;">‚úì Mark as Completed</button>
                <button onclick="viewDoomScrollData()" class="secondary">üëÅÔ∏è View Current Data</button>
            </div>
            
            <div style="margin-top: 30px;">
                <h3 style="color: var(--yellow);">All Board Cells Status</h3>
                <div id="boardDiagnosticContent" style="max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px;">
                    <p style="color: #666;">Click "Load Board Data" to see all cells...</p>
                </div>
                <button onclick="loadBoardDiagnostic()" class="secondary" style="margin-top: 10px;">üìã Load Board Data</button>
            </div>
            
            <div style="margin-top: 20px;">
                <h3 style="color: var(--yellow);">Raw Data Viewer</h3>
                <pre id="rawDataViewer" style="background: #000; color: #0f0; padding: 15px; border-radius: 8px; overflow-x: auto; max-height: 300px; font-family: monospace; font-size: 12px;">
                    Click a button above to view data...
                </pre>
            </div>
            
            <button onclick="closeFirebaseDiagnostic()" style="margin-top: 20px; background: var(--pink); color: white;">Close Diagnostic</button>
        </div>
    </div>
    <div id="challengeWinnerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; overflow-y: auto; padding: 20px;">
        <div style="max-width: 1000px; margin: 0 auto; background: #1a1a1a; border-radius: 20px; padding: 30px; border: 3px solid var(--cyan);">
            <h2 style="color: var(--cyan); margin-bottom: 20px;">üèÜ CHALLENGE WINNER EDITOR</h2>
            
            <div style="margin-bottom: 20px;">
                <label style="color: var(--yellow);">Select Category & Value:</label>
                <select id="winnerEditorSelect" onchange="loadChallengeWinners()" style="width: 100%; margin-top: 10px;">
                    <option value="">Choose a completed cell...</option>
                </select>
            </div>
            
            <div id="challengeWinnerContent" style="display: none;">
                <h3 id="selectedCellTitle" style="color: var(--yellow); margin-bottom: 20px;"></h3>
                
                <div id="challengesList"></div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button onclick="saveChallengeWinners()" class="success">üíæ Save Winners</button>
                    <button onclick="autoDistributeWins()" class="secondary">üé≤ Auto-Distribute Wins</button>
                </div>
            </div>
            
            <button onclick="closeChallengeWinnerEditor()" style="margin-top: 20px; background: var(--pink); color: white;">Close Editor</button>
        </div>
    </div>
    <div id="walletRecoveryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; overflow-y: auto; padding: 20px;">
        <div style="max-width: 1400px; margin: 0 auto; background: #1a1a1a; border-radius: 20px; padding: 30px; border: 3px solid var(--cyan);">
            <h2 style="color: var(--cyan); margin-bottom: 20px;">üí∏ WALLET RECOVERY TOOL</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <!-- Left Panel - Current State -->
                <div>
                    <h3 style="color: var(--yellow); margin-bottom: 15px;">Current Wallet Status</h3>
                    <div style="background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; padding: 20px; max-height: 500px; overflow-y: auto;">
                        <div id="currentWalletStatus"></div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="color: var(--pink);">Quick Actions</h4>
                        <button onclick="exportWalletData()" class="secondary" style="margin-right: 10px;">üì• Export Current Data</button>
                        <button onclick="calculateFromChallenges()" class="secondary">üîÑ Recalculate from Challenges</button>
                    </div>
                </div>
                
                <!-- Right Panel - Recovery Options -->
                <div>
                    <h3 style="color: var(--yellow); margin-bottom: 15px;">Recovery Options</h3>
                    
                    <!-- Bulk Update Section -->
                    <div style="background: rgba(138,43,226,0.2); border: 2px solid var(--purple); border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: var(--purple); margin-bottom: 15px;">Bulk Wallet Update</h4>
                        <textarea id="bulkWalletData" placeholder="Paste wallet data here (format: founderId:amount per line)" 
                                 style="width: 100%; height: 150px; margin-bottom: 10px;"></textarea>
                        <button onclick="bulkUpdateWallets()" class="success">üíæ Apply Bulk Update</button>
                    </div>
                    
                    <!-- Manual Adjustments -->
                    <div style="background: rgba(255,255,0,0.1); border: 2px solid var(--yellow); border-radius: 10px; padding: 20px;">
                        <h4 style="color: var(--yellow); margin-bottom: 15px;">Manual Adjustment</h4>
                        <select id="recoveryFounderSelect" style="width: 100%; margin-bottom: 10px;">
                            <option value="">Select founder...</option>
                        </select>
                        <input type="number" id="recoveryAmount" placeholder="Amount to add/subtract" style="width: 100%; margin-bottom: 10px;">
                        <input type="text" id="recoveryReason" placeholder="Reason for adjustment" style="width: 100%; margin-bottom: 10px;">
                        <div style="display: flex; gap: 10px;">
                            <button onclick="applyManualAdjustment(1)" class="success">‚ûï Add</button>
                            <button onclick="applyManualAdjustment(-1)" class="danger">‚ûñ Subtract</button>
                            <button onclick="setExactAmount()" class="secondary">üìç Set Exact</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Audit Log -->
            <div style="margin-top: 30px;">
                <h3 style="color: var(--yellow);">Audit Log</h3>
                <div id="walletAuditLog" style="background: rgba(0,0,0,0.8); border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; padding: 15px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                    Wallet recovery tool initialized...
                </div>
            </div>
            
            <button onclick="closeWalletRecovery()" style="margin-top: 20px; background: var(--pink); color: white;">Close Recovery Tool</button>
        </div>
    </div>
</body>
</html>