<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B04RD R00M - Moderator Control</title>
    <style>
        :root {
            --purple: #8A2BE2;
            --cyan: #00FFFF;
            --yellow: #FFFF00;
            --pink: #FF69B4;
            --team1-color: #DC143C;
            --team2-color: #00BFFF;
            --glass: rgba(0,0,0,0.7);
            --glass-light: rgba(255,255,255,0.1);
            --blur: 10px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            background-image: url('assets/board-room.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: -1;
        }

        .header {
            background: var(--glass);
            backdrop-filter: blur(var(--blur));
            padding: 20px;
            text-align: center;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 3px solid rgba(255,255,255,0.3);
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 20px rgba(255,255,255,0.5), 3px 3px 0 #000;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .panel {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .panel:hover {
            border-color: var(--cyan);
            box-shadow: 0 10px 30px rgba(0,255,255,0.3);
        }

        .panel h2 {
            color: var(--cyan);
            margin-bottom: 20px;
            font-size: 1.8em;
            text-shadow: 0 0 10px var(--cyan);
        }

        .panel.priority {
            grid-column: 1 / -1;
            border-color: var(--yellow);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255,255,0,0.3); }
            50% { box-shadow: 0 0 40px rgba(255,255,0,0.6); }
        }

        /* Teams Display */
        .teams-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .team-panel {
            background: rgba(0,0,0,0.5);
            border: 3px solid;
            border-radius: 15px;
            padding: 20px;
        }

        .team-1 {
            border-color: var(--team1-color);
            background: rgba(220,20,60,0.1);
        }

        .team-2 {
            border-color: var(--team2-color);
            background: rgba(0,191,255,0.1);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .team-name {
            font-size: 1.3em;
            font-weight: bold;
        }

        .team-1 .team-name {
            color: var(--team1-color);
            text-shadow: 0 0 10px var(--team1-color);
        }

        .team-2 .team-name {
            color: var(--team2-color);
            text-shadow: 0 0 10px var(--team2-color);
        }

        .valuation {
            font-size: 1.8em;
            color: var(--yellow);
            font-weight: 900;
            text-shadow: 0 0 15px var(--yellow);
        }

        /* Board Status */
        .board-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .board-status {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .board-status.completed {
            background: rgba(0,255,0,0.2);
            border-color: #00ff00;
        }

        .board-status.active {
            background: rgba(255,255,0,0.2);
            border-color: var(--yellow);
            animation: pulse 1s ease-in-out infinite;
        }

        /* Pending Selection */
        .pending-box {
            background: rgba(255,255,0,0.1);
            border: 3px solid var(--yellow);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0%, 100% { border-color: var(--yellow); }
            50% { border-color: var(--pink); }
        }

        /* Challenge Display */
        .challenge-info {
            background: rgba(138,43,226,0.1);
            border: 2px solid var(--purple);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }

        .challenge-type {
            font-size: 1.5em;
            color: var(--yellow);
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 0 10px var(--yellow);
        }

        /* Player Selection Display */
        .player-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .selection-team {
            background: rgba(0,0,0,0.5);
            border: 2px solid;
            border-radius: 10px;
            padding: 15px;
        }

        .selected-player {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 8px;
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Buttons */
        button {
            background: var(--cyan);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 5px;
        }

        button:hover {
            background: var(--yellow);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(255,255,0,0.4);
        }

        button.danger {
            background: #ff3333;
            color: white;
        }

        button.danger:hover {
            background: #ff5555;
            box-shadow: 0 8px 25px rgba(255,51,51,0.4);
        }

        button.success {
            background: #00ff00;
            color: #000;
        }

        button.success:hover {
            background: #33ff33;
            box-shadow: 0 8px 25px rgba(0,255,0,0.4);
        }

        button.secondary {
            background: var(--purple);
            color: white;
        }

        button.secondary:hover {
            background: var(--pink);
            box-shadow: 0 8px 25px rgba(255,105,180,0.4);
        }

        /* Log */
        .log-container {
            background: rgba(0,0,0,0.8);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }

        .log-entry {
            margin: 3px 0;
            padding: 3px;
        }

        .log-entry.success {
            color: #00ff00;
        }

        .log-entry.error {
            color: #ff3333;
        }

        .log-entry.warning {
            color: var(--yellow);
        }

        /* Challenge Result */
        .result-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .winner-button {
            padding: 20px;
            font-size: 1.2em;
            border: 3px solid;
            background: rgba(0,0,0,0.5);
        }

        .winner-button.team-1 {
            border-color: var(--team1-color);
            color: var(--team1-color);
        }

        .winner-button.team-2 {
            border-color: var(--team2-color);
            color: var(--team2-color);
        }

        .winner-button:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.online {
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }

        .status-indicator.offline {
            background: #ff3333;
            box-shadow: 0 0 10px #ff3333;
        }

        /* Eliminated Players */
        .eliminated-list {
            background: rgba(255,0,0,0.1);
            border: 2px solid rgba(255,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .eliminated-player {
            color: #ff6666;
            margin: 5px 0;
            text-decoration: line-through;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .teams-container {
                grid-template-columns: 1fr;
            }
            
            .panel.priority {
                grid-column: 1;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎮 B04RD R00M MODERATOR 🎮</h1>
    </div>

    <div class="main-grid">
        <!-- PENDING ACTIONS - Priority Panel -->
        <div class="panel priority" id="pendingPanel" style="display: none;">
            <h2>⚠️ PENDING ACTION REQUIRED</h2>
            <div id="pendingContent"></div>
        </div>

        <!-- GAME STATUS -->
        <div class="panel">
            <h2>📊 Game Status</h2>
            <div class="teams-container">
                <div class="team-panel team-1">
                    <div class="team-header">
                        <div class="team-name">Y2KET CORP.</div>
                        <div class="valuation" id="val1">$0</div>
                    </div>
                    <div id="team1Status"></div>
                </div>
                <div class="team-panel team-2">
                    <div class="team-header">
                        <div class="team-name">SERIES A(POCALYPSE)</div>
                        <div class="valuation" id="val2">$0</div>
                    </div>
                    <div id="team2Status"></div>
                </div>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <h3 style="color: var(--yellow); margin-bottom: 10px;">Current Turn: Team <span id="currentTeam">1</span></h3>
                <button onclick="switchTurn()" class="secondary">Switch Turn</button>
                <button onclick="pauseGame()" class="danger">Pause Game</button>
            </div>
        </div>

        <!-- BOARD STATUS -->
        <div class="panel">
            <h2>🎯 Board Status</h2>
            <div class="board-grid" id="boardGrid">
                <!-- Board status will be populated here -->
            </div>
            <div style="margin-top: 20px;">
                <button onclick="resetBoard()" class="danger">Reset All Boards</button>
                <button onclick="checkWinConditions()" class="success">Check Win Conditions</button>
            </div>
        </div>

        <!-- ACTIVE CHALLENGE -->
        <div class="panel" id="activePanel" style="display: none;">
            <h2>⚔️ Active Challenge</h2>
            <div id="activeChallengeContent"></div>
        </div>

        <!-- PLAYER SELECTIONS -->
        <div class="panel" id="selectionPanel" style="display: none;">
            <h2>👥 Player Selections</h2>
            <div id="playerSelectionContent"></div>
        </div>

        <!-- WEALTH TRACKER -->
        <div class="panel">
            <h2>💰 Wealth Tracker</h2>
            <div id="wealthTracker"></div>
            <div class="eliminated-list" id="eliminatedList" style="display: none;">
                <h3 style="color: #ff6666; margin-bottom: 10px;">❌ Eliminated Players</h3>
                <div id="eliminatedPlayers"></div>
            </div>
        </div>

        <!-- CHALLENGE EDITOR -->
        <div class="panel">
            <h2>📝 Challenge Editor</h2>
            <div style="margin-bottom: 15px;">
                <select id="boardSelect" onchange="loadChallenge()" style="width: 100%;">
                    <option value="">Select a board to edit...</option>
                </select>
            </div>
            <div id="challengeEditor" style="display: none;">
                <div style="background: rgba(255,255,0,0.1); border: 2px solid var(--yellow); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                    <h4 style="color: var(--yellow); margin-bottom: 10px;">🏢 Team Battle Challenge</h4>
                    <textarea id="teamChallengeDescription" placeholder="Enter TEAM challenge (50% company wealth)..." 
                              style="width: 100%; min-height: 80px; margin-bottom: 10px;"></textarea>
                    <input type="number" id="teamValue" placeholder="Minimum stake ($)" min="0" step="100" value="5000">
                </div>
                
                <div style="background: rgba(138,43,226,0.1); border: 2px solid var(--purple); border-radius: 10px; padding: 15px;">
                    <h4 style="color: var(--purple); margin-bottom: 10px;">💰 2v2 Duel Challenge</h4>
                    <textarea id="personalChallengeDescription" placeholder="Enter 2v2 challenge (25% personal wealth)..." 
                              style="width: 100%; min-height: 80px; margin-bottom: 10px;"></textarea>
                    <input type="number" id="personalValue" placeholder="Minimum stake ($)" min="0" step="100" value="2500">
                </div>
                
                <button onclick="saveChallenge()" class="success" style="width: 100%; margin-top: 15px;">
                    💾 Save Both Challenges
                </button>
            </div>
            <div style="margin-top: 20px;">
                <button onclick="loadDefaultChallenges()" class="secondary">Load Default Challenges</button>
            </div>
        </div>

        <!-- CONTROLS -->
        <div class="panel">
            <h2>🎮 Quick Controls</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="forceEndChallenge()" class="danger">Force End Challenge</button>
                <button onclick="clearPendingSelection()" class="secondary">Clear Pending</button>
                <button onclick="resetPlayerSelections()" class="secondary">Reset Selections</button>
                <button onclick="recalculateWealth()" class="success">Recalculate Wealth</button>
                <button onclick="viewFirebaseData()" class="secondary">View Raw Data</button>
                <button onclick="updateCompanyValuation(1, 5000)">+ $5,000 Team 1</button>
            <button onclick="updateCompanyValuation(1, -5000)">- $5,000 Team 2</button>
                <button onclick="emergencyReset()" class="danger">EMERGENCY RESET</button>
            </div>
        </div>

        <!-- LOG -->
        <div class="panel">
            <h2>📜 Activity Log</h2>
            <div class="log-container" id="gameLog"></div>
            <button onclick="clearLog()" style="margin-top: 10px;">Clear Log</button>
        </div>

        <!-- CONNECTION STATUS -->
        <div class="panel">
            <h2>📡 Connection Status</h2>
            <p><span class="status-indicator offline" id="firebaseStatus"></span>Firebase: <span id="connectionText">Connecting...</span></p>
            <p><span class="status-indicator offline" id="gameStatus"></span>Board Room: <span id="boardRoomText">Initializing...</span></p>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDnHE2Ay2wqZVC4Xf2PsHHppVoVfNPk0hI",
            authDomain: "f0und3rzg4m3-b04rd.firebaseapp.com",
            databaseURL: "https://f0und3rzg4m3-b04rd-default-rtdb.firebaseio.com",
            projectId: "f0und3rzg4m3-b04rd",
            storageBucket: "f0und3rzg4m3-b04rd.firebasestorage.app",
            messagingSenderId: "484982613831",
            appId: "1:484982613831:web:9b655b3d66d66b3b5e8e62",
            measurementId: "G-MPN2LP1Q6X"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Board types
        const boardTypes = [
            { id: 'whiteboard', name: 'Whiteboard' },
            { id: 'surfboard', name: 'Surfboard' },
            { id: 'soundboard', name: 'Soundboard' },
            { id: 'ouijaboard', name: 'Ouija Board' },
            { id: 'ironingboard', name: 'Ironing Board' },
            { id: 'clipboard', name: 'Clipboard' },
            { id: 'chessboard', name: 'Chessboard' },
            { id: 'cheeseboard', name: 'Cheeseboard' },
            { id: 'cardboard', name: 'Cardboard' }
        ];

        // Game state
        let gameState = {
            companies: { 1: { valuation: 0 }, 2: { valuation: 0 } },
            currentTeam: 1,
            activeChallenge: null,
            pendingSelection: null,
            playerSelections: { 1: [], 2: [] },
            selectionPhase: null,
            boards: {},
            founderWealth: {},
            founders: {},
            eliminatedPlayers: []
        };

        // Logging
        function log(message, type = 'normal') {
            const logDiv = document.getElementById('gameLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('gameLog').innerHTML = '';
            log('Log cleared', 'success');
        }

        // Connection monitoring
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('firebaseStatus');
            const textEl = document.getElementById('connectionText');
            
            if (connected) {
                statusEl.className = 'status-indicator online';
                textEl.textContent = 'Connected';
                log('Firebase connected', 'success');
            } else {
                statusEl.className = 'status-indicator offline';
                textEl.textContent = 'Disconnected';
                log('Firebase disconnected', 'error');
            }
        }

        // Update board status display
        function updateBoardDisplay() {
            const grid = document.getElementById('boardGrid');
            grid.innerHTML = '';
            
            boardTypes.forEach(board => {
                const status = gameState.boards[board.id] || { completed: false };
                const div = document.createElement('div');
                div.className = `board-status ${status.completed ? 'completed' : ''} ${gameState.activeChallenge?.boardId === board.id ? 'active' : ''}`;
                div.innerHTML = `
                    <div style="font-weight: bold;">${board.name}</div>
                    <div style="font-size: 0.8em; margin-top: 5px;">
                        ${status.completed ? '✓ Complete' : 'Available'}
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        // Handle pending selection
        function showPendingSelection(selection) {
            const panel = document.getElementById('pendingPanel');
            const content = document.getElementById('pendingContent');
            
            panel.style.display = 'block';
            
            content.innerHTML = `
                <div class="pending-box">
                    <h3>Board Selection Request</h3>
                    <p>Team ${selection.team} wants to select:</p>
                    <p style="font-size: 1.5em; color: var(--yellow); margin: 15px 0;">
                        ${boardTypes.find(b => b.id === selection.boardId)?.name || selection.boardId}
                    </p>
                    <p style="font-size: 1.3em; color: var(--pink);">
                        Challenge Type: ${selection.challengeType === 'team' ? 'TEAM BATTLE (50% company)' : '2v2 DUEL (25% personal)'}
                    </p>
                    <div style="margin-top: 20px;">
                        <button onclick="approveSelection()" class="success">✓ Approve</button>
                        <button onclick="rejectSelection()" class="danger">✗ Reject</button>
                    </div>
                </div>
            `;
        }

        // Approve selection
        function approveSelection() {
            if (!gameState.pendingSelection) return;
            
            const { boardId, challengeType, team } = gameState.pendingSelection;
            
            // Start player selection phase
            database.ref('boardRoom/selectionPhase').set({
                active: true,
                boardId: boardId,
                challengeType: challengeType,
                team: team,
                timestamp: Date.now()
            });
            
            // Clear pending
            database.ref('boardRoom/pendingSelection').remove();
            
            log(`Approved ${challengeType} for ${boardId} by Team ${team}`, 'success');
        }

        // Reject selection
        function rejectSelection() {
            database.ref('boardRoom/pendingSelection').remove();
            log('Rejected board selection', 'error');
        }

        // Show player selection status
        function showPlayerSelections() {
            const panel = document.getElementById('selectionPanel');
            const content = document.getElementById('playerSelectionContent');
            
            if (!gameState.selectionPhase?.active) {
                panel.style.display = 'none';
                return;
            }
            
            panel.style.display = 'block';
            
            content.innerHTML = `
                <div class="challenge-info">
                    <div class="challenge-type">
                        ${gameState.selectionPhase.challengeType === 'team' ? 'TEAM BATTLE' : '2v2 DUEL'}
                    </div>
                    <div class="player-selection">
                        <div class="selection-team" style="border-color: var(--team1-color);">
                            <h4 style="color: var(--team1-color);">Team 1 Selections</h4>
                            <div id="team1Selections">${renderSelections(1)}</div>
                        </div>
                        <div class="selection-team" style="border-color: var(--team2-color);">
                            <h4 style="color: var(--team2-color);">Team 2 Selections</h4>
                            <div id="team2Selections">${renderSelections(2)}</div>
                        </div>
                    </div>
                    ${bothTeamsReady() ? `
                        <button onclick="startChallenge()" class="success" style="width: 100%; margin-top: 20px;">
                            ⚔️ START CHALLENGE
                        </button>
                    ` : '<p style="text-align: center; color: #999; margin-top: 20px;">Waiting for both teams to select 2 players...</p>'}
                </div>
            `;
        }
        function promptValuationChange(team) {
    const input = prompt(`Enter amount to change Team ${team}'s valuation (positive or negative):`);
    const delta = parseInt(input);
    if (!isNaN(delta)) {
        updateCompanyValuation(team, delta);
    } else {
        alert('Invalid number.');
    }
}
function updateCompanyValuation(teamNumber, delta) {
    const companyRef = database.ref(`game/companies/${teamNumber}/valuation`);
    companyRef.transaction(currentVal => {
        return (currentVal || 0) + delta;
    }).then(result => {
        if (result.committed) {
            log(`Updated Team ${teamNumber} valuation by $${delta}`, 'success');
        } else {
            log(`Transaction for Team ${teamNumber} was not committed`, 'error');
        }
    }).catch(error => {
        log(`Error updating valuation: ${error}`, 'error');
    });
}
        function renderSelections(team) {
            const selections = gameState.playerSelections[team] || [];
            
            if (selections.length === 0) {
                return '<p style="color: #666;">No players selected yet...</p>';
            }
            
            return selections.map(playerId => {
                const founder = Object.values(gameState.founders).flat().find(f => f.id === playerId);
                if (!founder) return '';
                
                const wealth = gameState.founderWealth[playerId] || 0;
                return `
                    <div class="selected-player">
                        <img src="../jeopardy/assets/founders/${founder.image}" class="player-avatar" 
                             onerror="this.src='../jeopardy/assets/founders/default.png'">
                        <div>
                            <div>${founder.name}</div>
                            <div style="color: var(--yellow); font-size: 0.9em;">$${wealth.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function bothTeamsReady() {
            return gameState.playerSelections[1]?.length === 2 && 
                   gameState.playerSelections[2]?.length === 2;
        }

        // Challenge storage
        let challenges = {};

        // Default challenges
        const defaultChallenges = {
            'whiteboard': {
                teamChallenge: 'Each team has 2 minutes to create the worst possible pitch deck. Most cringe wins!',
                personalChallenge: 'Face-off: Pitch your worst idea with complete conviction for 60 seconds each',
                teamValue: 5000,
                personalValue: 2500
            },
            'surfboard': {
                teamChallenge: 'Team charades: Act out your entire business model using only surf moves',
                personalChallenge: 'Describe your startup using only surfer slang - opponent translates',
                teamValue: 5000,
                personalValue: 2500
            },
            'soundboard': {
                teamChallenge: 'Create a company theme song using only mouth sounds - full team performance',
                personalChallenge: 'Beatbox battle: Create startup jingles, audience picks winner',
                teamValue: 5000,
                personalValue: 2500
            },
            'ouijaboard': {
                teamChallenge: 'Séance: Channel your team\'s dead startups and explain their demise',
                personalChallenge: 'Spirit duel: Best ghost impression of a failed founder',
                teamValue: 5000,
                personalValue: 2500
            },
            'ironingboard': {
                teamChallenge: 'Team relay: Iron clothes while explaining each business pivot',
                personalChallenge: 'Speed ironing while pitching - first wrinkle-free pitch wins',
                teamValue: 5000,
                personalValue: 2500
            },
            'clipboard': {
                teamChallenge: 'Create a full startup funeral program with eulogies from the team',
                personalChallenge: 'Signup sheet showdown: Most creative petition for startup survival',
                teamValue: 5000,
                personalValue: 2500
            },
            'chessboard': {
                teamChallenge: 'Team chess: Each move must be explained as a business strategy',
                personalChallenge: 'Chess metaphor battle: Best startup story using only chess terms',
                teamValue: 5000,
                personalValue: 2500
            },
            'cheeseboard': {
                teamChallenge: 'Full team cheese tasting while matching VCs to cheese personalities',
                personalChallenge: 'Cheese pun duel: Most startup cheese puns in 60 seconds',
                teamValue: 5000,
                personalValue: 2500
            },
            'cardboard': {
                teamChallenge: 'Team builds a life-size cardboard prototype of their app',
                personalChallenge: 'Cardboard armor battle: Pitch while wearing cardboard suits',
                teamValue: 5000,
                personalValue: 2500
            }
        };

        // Load challenges from Firebase
        function loadChallengesFromFirebase() {
            // Always populate the board selector first
            populateBoardSelect();
            
            database.ref('boardRoom/challenges').once('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    challenges = data;
                    log('Loaded challenges from Firebase', 'success');
                } else {
                    challenges = defaultChallenges;
                    log('Using default challenges', 'warning');
                }
            }).catch(error => {
                // If Firebase fails, still use defaults
                challenges = defaultChallenges;
                log('Error loading challenges, using defaults', 'error');
            });
        }

        // Populate board selector
        function populateBoardSelect() {
            const select = document.getElementById('boardSelect');
            select.innerHTML = '<option value="">Select a board to edit...</option>';
            
            boardTypes.forEach(board => {
                const option = document.createElement('option');
                option.value = board.id;
                option.textContent = board.name;
                select.appendChild(option);
            });
        }

        // Load challenge for editing
        function loadChallenge() {
            const boardId = document.getElementById('boardSelect').value;
            const editor = document.getElementById('challengeEditor');
            
            if (!boardId) {
                editor.style.display = 'none';
                return;
            }
            
            editor.style.display = 'block';
            const challenge = challenges[boardId] || defaultChallenges[boardId] || {
                teamChallenge: '',
                personalChallenge: '',
                teamValue: 5000,
                personalValue: 2500
            };
            
            document.getElementById('teamChallengeDescription').value = challenge.teamChallenge || challenge.description || '';
            document.getElementById('personalChallengeDescription').value = challenge.personalChallenge || challenge.description || '';
            document.getElementById('teamValue').value = challenge.teamValue;
            document.getElementById('personalValue').value = challenge.personalValue;
        }

        // Save challenge
        function saveChallenge() {
            const boardId = document.getElementById('boardSelect').value;
            if (!boardId) return;
            
            const challenge = {
                teamChallenge: document.getElementById('teamChallengeDescription').value,
                personalChallenge: document.getElementById('personalChallengeDescription').value,
                teamValue: parseInt(document.getElementById('teamValue').value) || 5000,
                personalValue: parseInt(document.getElementById('personalValue').value) || 2500
            };
            
            challenges[boardId] = challenge;
            
            // Save to Firebase
            database.ref(`boardRoom/challenges/${boardId}`).set(challenge)
                .then(() => {
                    log(`Saved challenges for ${boardId}`, 'success');
                    alert('Challenges saved!');
                })
                .catch(error => {
                    log(`Error saving challenge: ${error}`, 'error');
                });
        }

        // Load default challenges
        function loadDefaultChallenges() {
            if (confirm('Load default challenges? This will overwrite any custom challenges.')) {
                challenges = defaultChallenges;
                database.ref('boardRoom/challenges').set(defaultChallenges)
                    .then(() => {
                        log('Loaded default challenges', 'success');
                        alert('Default challenges loaded!');
                        loadChallenge(); // Refresh current editor
                    });
            }
        }

        // Start challenge (updated to use stored challenges)
        function startChallenge() {
            if (!gameState.selectionPhase || !bothTeamsReady()) return;
            
            const { boardId, challengeType } = gameState.selectionPhase;
            const board = boardTypes.find(b => b.id === boardId);
            
            // Get challenge from storage
            const storedChallenge = challenges[boardId] || defaultChallenges[boardId];
            
            // Create challenge with appropriate description and value based on type
            const challenge = {
                description: challengeType === 'team' ? 
                    (storedChallenge.teamChallenge || `${board.name} Team Challenge`) : 
                    (storedChallenge.personalChallenge || `${board.name} 2v2 Duel`),
                value: challengeType === 'team' ? storedChallenge.teamValue : storedChallenge.personalValue
            };
            
            // Set active challenge
            database.ref('boardRoom/activeChallenge').set({
                boardId: boardId,
                challengeType: challengeType,
                challenge: challenge,
                selectedPlayers: gameState.playerSelections,
                timestamp: Date.now()
            });
            
            // Clear selection phase
            database.ref('boardRoom/selectionPhase').remove();
            database.ref('boardRoom/playerSelections').remove();
            
            log(`Started ${challengeType} challenge on ${board.name}`, 'success');
        }

        // Show active challenge
        function showActiveChallenge() {
            const panel = document.getElementById('activePanel');
            const content = document.getElementById('activeChallengeContent');
            
            if (!gameState.activeChallenge) {
                panel.style.display = 'none';
                return;
            }
            
            panel.style.display = 'block';
            const { boardId, challengeType, challenge } = gameState.activeChallenge;
            const board = boardTypes.find(b => b.id === boardId);
            
            content.innerHTML = `
                <div class="challenge-info">
                    <h3 style="color: var(--yellow); text-align: center; margin-bottom: 20px;">
                        ${board.name} - ${challengeType === 'team' ? 'TEAM BATTLE' : '2v2 DUEL'}
                    </h3>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 1.2em; color: #ccc;">${challenge.description}</div>
                        <div style="font-size: 2em; color: var(--yellow); margin-top: 10px;">$${challenge.value}</div>
                    </div>
                    
                    <div class="player-selection">
                        ${renderChallengeTeam(1)}
                        ${renderChallengeTeam(2)}
                    </div>
                    
                    <h3 style="text-align: center; margin: 20px 0; color: var(--pink);">Who Won?</h3>
                    <div class="result-buttons">
                        <button class="winner-button team-1" onclick="declareWinner(1)">
                            Team 1 Wins
                        </button>
                        <button class="winner-button team-2" onclick="declareWinner(2)">
                            Team 2 Wins
                        </button>
                    </div>
                    <button onclick="declareTie()" class="secondary" style="width: 100%; margin-top: 10px;">
                        It's a Tie
                    </button>
                </div>
            `;
        }

        function renderChallengeTeam(team) {
            const players = gameState.activeChallenge.selectedPlayers[team] || [];
            const teamColor = team === 1 ? 'var(--team1-color)' : 'var(--team2-color)';
            const teamName = team === 1 ? 'Y2KET' : 'SERIES A';
            
            return `
                <div class="selection-team" style="border-color: ${teamColor};">
                    <h4 style="color: ${teamColor};">${teamName}</h4>
                    ${players.map(playerId => {
                        const founder = Object.values(gameState.founders).flat().find(f => f.id === playerId);
                        if (!founder) return '';
                        const wealth = gameState.founderWealth[playerId] || 0;
                        return `
                            <div class="selected-player">
                                <img src="../jeopardy/assets/founders/${founder.image}" class="player-avatar">
                                <div>
                                    <div>${founder.name}</div>
                                    <div style="color: var(--yellow);">$${wealth.toLocaleString()}</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Declare winner
        function declareWinner(winnerTeam) {
            if (!gameState.activeChallenge) return;
            
            const loserTeam = winnerTeam === 1 ? 2 : 1;
            
            // Send result to be processed
            database.ref('boardRoom/lastResult').set({
                winnerId: winnerTeam,
                loserId: loserTeam,
                challengeType: gameState.activeChallenge.challengeType,
                boardId: gameState.activeChallenge.boardId,
                processed: false,
                timestamp: Date.now()
            });
            
            // Mark board as completed
            database.ref(`boardRoom/boards/${gameState.activeChallenge.boardId}`).set({
                completed: true,
                winner: winnerTeam,
                timestamp: Date.now()
            });
            
            // Clear active challenge
            database.ref('boardRoom/activeChallenge').remove();
            
            // Set next team
            database.ref('game/currentTeam').set(winnerTeam);
            
            log(`Team ${winnerTeam} won the challenge!`, 'success');
        }

        function declareTie() {
            if (!gameState.activeChallenge) return;
            
            // Mark board as completed with no winner
            database.ref(`boardRoom/boards/${gameState.activeChallenge.boardId}`).set({
                completed: true,
                winner: null,
                timestamp: Date.now()
            });
            
            // Clear active challenge
            database.ref('boardRoom/activeChallenge').remove();
            
            log('Challenge ended in a tie', 'warning');
        }

        // Update wealth display
        function updateWealthTracker() {
            const tracker = document.getElementById('wealthTracker');
            const allFounders = Object.values(gameState.founders).flat();
            
            // Sort by wealth
            const wealthyFounders = allFounders
                .map(f => ({ ...f, wealth: gameState.founderWealth[f.id] || 0 }))
                .filter(f => f.wealth > 0)
                .sort((a, b) => b.wealth - a.wealth)
                .slice(0, 10);
            
            tracker.innerHTML = wealthyFounders.map((f, idx) => {
                const teamColor = f.team === 1 ? 'var(--team1-color)' : 'var(--team2-color)';
                return `
                    <div style="display: flex; justify-content: space-between; padding: 8px; 
                               background: rgba(255,255,255,0.05); margin: 5px 0; border-radius: 8px;
                               border-left: 4px solid ${teamColor};">
                        <span>${idx + 1}. ${f.name}</span>
                        <span style="color: var(--yellow);">$${f.wealth.toLocaleString()}</span>
                    </div>
                `;
            }).join('') || '<p style="color: #666; text-align: center;">No wealth accumulated yet</p>';
            
            // Update eliminated players
            updateEliminatedList();
        }

        function updateEliminatedList() {
            const eliminated = gameState.eliminatedPlayers || [];
            if (eliminated.length === 0) {
                document.getElementById('eliminatedList').style.display = 'none';
                return;
            }
            
            document.getElementById('eliminatedList').style.display = 'block';
            const list = document.getElementById('eliminatedPlayers');
            
            list.innerHTML = eliminated.map(playerId => {
                const founder = Object.values(gameState.founders).flat().find(f => f.id === playerId);
                return founder ? `<div class="eliminated-player">${founder.name}</div>` : '';
            }).filter(Boolean).join('');
        }

        // Control functions
        function switchTurn() {
            const newTeam = gameState.currentTeam === 1 ? 2 : 1;
            database.ref('game/currentTeam').set(newTeam);
            log(`Switched turn to Team ${newTeam}`, 'success');
        }

        function pauseGame() {
            if (confirm('Pause the game?')) {
                database.ref('boardRoom/paused').set(true);
                log('Game paused', 'warning');
            }
        }

        function clearPendingSelection() {
            database.ref('boardRoom/pendingSelection').remove();
            log('Cleared pending selection', 'success');
        }

        function resetPlayerSelections() {
            database.ref('boardRoom/playerSelections').remove();
            database.ref('boardRoom/selectionPhase').remove();
            log('Reset player selections', 'success');
        }

        function forceEndChallenge() {
            if (confirm('Force end the current challenge without a winner?')) {
                database.ref('boardRoom/activeChallenge').remove();
                log('Force ended challenge', 'error');
            }
        }

        function resetBoard() {
            if (confirm('Reset ALL boards? This will clear all progress!')) {
                database.ref('boardRoom/boards').remove();
                log('Reset all boards', 'error');
            }
        }

        function checkWinConditions() {
            // Check bankruptcy
            const team1Broke = gameState.companies[1].valuation <= 0;
            const team2Broke = gameState.companies[2].valuation <= 0;
            
            if (team1Broke || team2Broke) {
                alert(`💀 BANKRUPTCY WIN! Team ${team1Broke ? 2 : 1} wins!`);
                log(`GAME OVER - Team ${team1Broke ? 2 : 1} wins by bankruptcy!`, 'success');
                return;
            }
            
            // Check all boards complete
            const completedBoards = Object.keys(gameState.boards).filter(b => gameState.boards[b].completed).length;
            if (completedBoards === boardTypes.length) {
                // Get top 4 wealth holders
                const allFounders = Object.values(gameState.founders).flat();
                const topWealth = allFounders
                    .map(f => ({ ...f, wealth: gameState.founderWealth[f.id] || 0 }))
                    .sort((a, b) => b.wealth - a.wealth)
                    .slice(0, 4);
                
                alert(`🏆 ALL BOARDS COMPLETE! Top 4 advance:\n${topWealth.map((f, i) => `${i+1}. ${f.name}: $${f.wealth}`).join('\n')}`);
                log('GAME OVER - All boards complete!', 'success');
            } else {
                alert(`Progress: ${completedBoards}/${boardTypes.length} boards complete\nNo win conditions met yet.`);
            }
        }

        function recalculateWealth() {
            if (confirm('Recalculate all wealth? This will check for $0 eliminations.')) {
                const eliminated = [];
                Object.entries(gameState.founderWealth).forEach(([founderId, wealth]) => {
                    if (wealth <= 0) {
                        eliminated.push(founderId);
                    }
                });
                
                database.ref('boardRoom/eliminatedPlayers').set(eliminated);
                log(`Updated eliminated players: ${eliminated.length} players at $0`, 'warning');
            }
        }

        function viewFirebaseData() {
            console.log('Current Game State:', gameState);
            alert('Game state logged to console (F12)');
        }

        function emergencyReset() {
            if (confirm('⚠️ EMERGENCY RESET ⚠️\n\nThis will reset the Board Room game but preserve Jeopardy data.\n\nAre you sure?')) {
                if (confirm('FINAL CONFIRMATION: Reset Board Room game?')) {
                    database.ref('boardRoom').remove();
                    log('EMERGENCY RESET EXECUTED', 'error');
                    alert('Board Room game reset. Refresh the page.');
                }
            }
        }

        // Setup listeners
        function setupListeners() {
            // Connection
            database.ref('.info/connected').on('value', (snapshot) => {
                updateConnectionStatus(snapshot.val() === true);
            });

            // Companies
            database.ref('game/companies').on('value', (snapshot) => {
                const companies = snapshot.val() || {};
                gameState.companies = companies;
                document.getElementById('val1').textContent = `$${(companies[1]?.valuation || 0).toLocaleString()}`;
                document.getElementById('val2').textContent = `$${(companies[2]?.valuation || 0).toLocaleString()}`;
            });

            // Current team
            database.ref('game/currentTeam').on('value', (snapshot) => {
                gameState.currentTeam = snapshot.val() || 1;
                document.getElementById('currentTeam').textContent = gameState.currentTeam;
            });

            // Founders
            database.ref('game/founders').on('value', (snapshot) => {
                gameState.founders = snapshot.val() || {};
            });

            // Founder wealth
            database.ref('game/founderWealth').on('value', (snapshot) => {
                gameState.founderWealth = snapshot.val() || {};
                updateWealthTracker();
            });

            // Board states
            database.ref('boardRoom/boards').on('value', (snapshot) => {
                gameState.boards = snapshot.val() || {};
                updateBoardDisplay();
            });

            // Pending selection
            database.ref('boardRoom/pendingSelection').on('value', (snapshot) => {
                gameState.pendingSelection = snapshot.val();
                if (gameState.pendingSelection) {
                    showPendingSelection(gameState.pendingSelection);
                } else {
                    document.getElementById('pendingPanel').style.display = 'none';
                }
            });

            // Selection phase
            database.ref('boardRoom/selectionPhase').on('value', (snapshot) => {
                gameState.selectionPhase = snapshot.val();
                showPlayerSelections();
            });

            // Player selections
            database.ref('boardRoom/playerSelections').on('value', (snapshot) => {
                const selections = snapshot.val() || {};
                gameState.playerSelections = {
                    1: selections[1]?.players || [],
                    2: selections[2]?.players || []
                };
                showPlayerSelections();
            });

            // Active challenge
            database.ref('boardRoom/activeChallenge').on('value', (snapshot) => {
                gameState.activeChallenge = snapshot.val();
                showActiveChallenge();
            });

            // Eliminated players
            database.ref('boardRoom/eliminatedPlayers').on('value', (snapshot) => {
                gameState.eliminatedPlayers = snapshot.val() || [];
                updateEliminatedList();
            });

            // Game status
            database.ref('boardRoom').on('value', (snapshot) => {
                const exists = snapshot.exists();
                const statusEl = document.getElementById('gameStatus');
                const textEl = document.getElementById('boardRoomText');
                
                if (exists) {
                    statusEl.className = 'status-indicator online';
                    textEl.textContent = 'Active';
                } else {
                    statusEl.className = 'status-indicator offline';
                    textEl.textContent = 'Not initialized';
                }
            });
        }

        // Initialize
        window.onload = () => {
            setupListeners();
            
            // Populate the board selector immediately
            populateBoardSelect();
            
            // Then load challenges
            loadChallengesFromFirebase();
            
            log('Board Room Moderator initialized', 'success');
            
            // Initialize board room structure if needed
            database.ref('boardRoom').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    database.ref('boardRoom').set({
                        boards: {},
                        currentTeam: 1,
                        eliminatedPlayers: []
                    });
                    log('Initialized Board Room structure', 'success');
                }
            });
        };
    </script>
</body>
</html>